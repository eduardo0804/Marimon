@using Marimon.Enums
@model Marimon.ViewModel.ServicioReservaViewModel
@{
    ViewData["Title"] = "Consultar Servicios";
    Layout = "~/Views/Shared/_LayoutServicio.cshtml";
}
@* <link href="/css/styleListaAuto.css" rel="stylesheet" type="text/css"> *@

<style>
    .filtros-box {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .filtros-box label {
        font-weight: 600;
    }

    .filtros-box .form-check {
        margin-bottom: 8px;
    }

    .filtros-box .form-control {
        border-radius: 4px;
    }

    .filtros-box button {
        border-radius: 4px;
        font-weight: bold;
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
    }

    .modern-table th,
    .modern-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    .modern-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .modern-table .table-row:hover {
        background-color: #f9f9f9;
    }
</style>

<div class="container mt-4">
    <h2>Consultar Servicios</h2>

    <div class="row">
        <!-- Filtros a la izquierda -->
        <div class="col-md-4">
            <div class="filtros-box">
                <label>Selecciona Servicios:</label>
                <div class="form-group border rounded p-2 mb-3" style="max-height: 200px; overflow-y: auto;">
                    @foreach (var servicio in Model.Servicios)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="servicios" value="@servicio.ser_nombre"
                                id="chk_@servicio.ser_nombre" @(Model.ServiciosSeleccionados.Contains(servicio.ser_nombre) ?
                                                                                          "checked" : "") />
                        <label class="form-check-label" for="chk_@servicio.ser_nombre">@servicio.ser_nombre</label>
                    </div>
                                        }
                </div>

                <div class="mb-3">
                    <label for="fechaDesde">Desde:</label>
                    <input type="date" id="fechaDesde" class="form-control"
                        value="@Context.Request.Query["fechaDesde"]" />
                </div>
                <div class="mb-3">
                    <label for="fechaHasta">Hasta:</label>
                    <input type="date" id="fechaHasta" class="form-control"
                        value="@Context.Request.Query["fechaHasta"]" />
                </div>

                <button class="btn btn-primary w-100" onclick="filtrarReservas()">Filtrar</button>
            </div>
        </div>

        <!-- Tabla a la derecha -->
        <div class="col-md-8">
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>PLACA</th>
                            <th>FECHA</th>
                            <th>HORA</th>
                            <th>SERVICIO</th>
                            <th>USUARIO</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Reservas != null && Model.Reservas.Any())
                        {
                            @foreach (var reserva in Model.Reservas)
                            {
                                <tr class="table-row">
                                    <td data-label="ID">@reserva.res_id</td>
                                    <td data-label="Placa">@reserva.res_placa</td>
                                    <td data-label="Fecha">@reserva.res_fecha.ToShortDateString()</td>
                                    <td data-label="Hora">@reserva.res_hora</td>
                                    <td data-label="Servicio">@reserva.Servicio?.ser_nombre</td>
                                    <td data-label="Usuario">@reserva.Usuario?.usu_nombre</td>
                                    <td data-label="Estado">
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#cambiarEstadoModal"
                                            data-reserva-id="@reserva.res_id" data-estado-actual="@reserva.Estado"
                                            class="text-decoration-none">

                                            @switch (reserva.Estado)
                                            {
                                                case EstadoReserva.Pendiente:
                                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                                    break;
                                                case EstadoReserva.Confirmada:
                                                    <span class="badge bg-primary">Confirmada</span>
                                                    break;
                                                case EstadoReserva.Cancelada:
                                                    <span class="badge bg-danger">Cancelada</span>
                                                    break;
                                                case EstadoReserva.Completada:
                                                    <span class="badge bg-success">Completada</span>
                                                    break;
                                            }
                                        </a>
                                    </td>

                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No hay servicios registrados.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cambiarEstadoModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="formCambiarEstado" method="post" asp-controller="Personal_Servicio" asp-action="CambiarEstadoReserva">
            @Html.AntiForgeryToken()
            <input type="hidden" name="reservaId" id="modalReservaId" />
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Cambiar estado de la reserva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalNuevoEstado" class="form-label">Nuevo estado</label>
                        <select class="form-select" id="modalNuevoEstado" name="nuevoEstado">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Confirmada">Confirmada</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="Completada">Completada</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function filtrarReservas() {
        var checkboxes = document.querySelectorAll('input[name="servicios"]:checked');
        var serviciosSeleccionados = Array.from(checkboxes).map(cb => cb.value);
        var desde = document.getElementById("fechaDesde").value;
        var hasta = document.getElementById("fechaHasta").value;

        if (desde && hasta && new Date(desde) > new Date(hasta)) {
            alert("La fecha 'Hasta' debe ser mayor o igual a la fecha 'Desde'.");
            return;
        }

        var url = '@Url.Action("ConsultarServicios", "Personal_Servicio")' + '?';

        if (serviciosSeleccionados.length > 0) {
            url += 'nombreServicio=' + encodeURIComponent(serviciosSeleccionados.join(',')) + '&';
        }

        if (desde) url += 'fechaDesde=' + desde + '&';
        if (hasta) url += 'fechaHasta=' + hasta;

        window.location.href = url;
    }
    const modal = document.getElementById('cambiarEstadoModal');
    modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const reservaId = button.getAttribute('data-reserva-id');
        const estadoActual = button.getAttribute('data-estado-actual');

        document.getElementById('modalReservaId').value = reservaId;
        document.getElementById('modalNuevoEstado').value = estadoActual;
    });
</script>
