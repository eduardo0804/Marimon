@model List<Marimon.Models.OrdenTrabajo>
@{
    ViewData["Title"] = "Ordenes de Trabajo";
    ViewData["ActivePage"] = "OrdenTrabajo";
    Layout = "_LayoutServicio";
}
@section Styles {
    <link rel="stylesheet" href="~/css/ordenTrabajo.css" />
}
<ol class="breadcrumb">
    <li class="breadcrumb-item">
        <a asp-area="" asp-controller="Personal_Servicio" asp-action="Index">Módulo de Servicio</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Orden de Trabajo</li>
</ol>
<button class="btn btn-primary" onclick="abrirModalRegistrarOrden()">
    Registrar Orden
</button>
<!-- ===== BUSCADOR ESTILO HEADER (MOVIDO FUERA DE LA TABLA) ===== -->
<div class="search-header-container">
    <div class="search-input-wrapper">
        <i class="fas fa-search search-header-icon" onclick="performSearchImmediate()"></i>
        <input type="text" id="searchInput" class="search-header-input"
            placeholder="Buscar por ID, cliente, servicio, estado..." autocomplete="off">
        <button type="button" class="btn btn-search" onclick="performSearchImmediate()">
            <i class="fas fa-search"></i>
            Buscar
        </button>
        <button type="button" class="btn btn-clear" onclick="clearSearch()">
            <i class="fas fa-times"></i>
            Limpiar
        </button>
    </div>
    <div class="search-results" id="searchResults"></div>
</div>

<!-- Mensaje cuando no hay resultados -->
<div class="no-results" id="noResults">
    <i class="fas fa-search icon"></i>
    <div>No se encontraron órdenes de trabajo que coincidan con tu búsqueda</div>
    <small style="color: #9ca3af; margin-top: 0.5rem; display: block;">
        Intenta con otros términos o verifica la ortografía
    </small>
</div>
<table class="table">

    <thead>
        <tr>
            <th>ID</th>
            <th>Servicio</th>
            <th>Reserva - Placa</th>
            <th>Cliente</th>
            <th>Estado Reserva</th>
            <th>Personal asignado</th>
            <th>Autoparte</th>
            <th>Descripción</th> <!-- Nueva columna -->
            <th>Descargar PDF</th> <!-- Nueva columna -->
        </tr>
    </thead>
    <tbody>
        @foreach (var orden in Model)
        {
            <tr>
                <td>@orden.OrdenTrabajoId</td>
                <td>@orden.Reserva?.Servicio?.ser_nombre</td>
                <td>@orden.Reserva?.res_placa</td>
                <td>@orden.Reserva?.Usuario?.usu_nombre @orden.Reserva?.Usuario?.usu_apellido</td>
                <td>@orden.Reserva?.Estado</td>
                <td>
                    <span id="personal-nombre-@orden.OrdenTrabajoId">
                        @if (orden.Personal != null)
                        {
                            @orden.Personal.usu_correo
                        }
                        else
                        {
                            <em>No asignado</em>
                        }
                    </span>
                    @if (orden.Personal == null)
                    {
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalPersonal"
                            data-ordenid="@orden.OrdenTrabajoId">Asignar</button>
                    }
                </td>
                <td>
                    <span id="autoparte-nombre-@orden.OrdenTrabajoId">
                        @if (orden.Autoparte != null)
                        {
                            @orden.Autoparte.aut_nombre
                        }
                        else
                        {
                            <em>No asignado</em>
                        }
                    </span>
                    @if (orden.Autoparte == null)
                    {
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAutoparte"
                            data-ordenid="@orden.OrdenTrabajoId">Asignar</button>
                    }
                </td>
                <td>@orden.Descripcion</td>
                <td>
                    @if (orden.Reserva?.Estado.ToString() == "Confirmada" || orden.Reserva?.Estado.ToString() ==
                                    "Completada")
                    {
                        <a href="@Url.Action("DescargarPdf", "Personal_Servicio", new { id = orden.OrdenTrabajoId })"
                            class="btn btn-outline-secondary btn-sm" target="_blank" title="Descargar PDF">
                            <i class="fa fa-file-pdf"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary btn-sm" disabled
                            title="Disponible solo si la reserva está confirmada o completada">
                            <i class="fa fa-file-pdf"></i>
                        </button>
                    }
                </td>

            </tr>
        }
    </tbody>
</table>


<div class="modal fade" id="modalAutoparte" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Asignar Autoparte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formAutoparte">
                    @* Token antifalsificación *@
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="ordenId" name="ordenId" />

                    <div class="mb-3">
                        <label for="categoriaSelect">Categoría</label>
                        <select id="categoriaSelect" class="form-select">
                            <option value="">Selecciona una categoría</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="autoparteSelect">Autoparte</label>
                        <select id="autoparteSelect" class="form-select" disabled>
                            <option value="">Selecciona una autoparte</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="guardarAutoparte()">Guardar Autoparte</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalPersonal" tabindex="-1" aria-labelledby="modalPersonalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Personal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formAsignarPersonal">
                    <input type="hidden" id="ordenIdPersonal" name="ordenId" />
                    <div class="mb-3">
                        <label for="personalSelect" class="form-label">Selecciona un personal</label>
                        <select class="form-select" id="personalSelect" name="personalId" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <!-- QUITAR el onclick y el type="submit" -->
                    <button type="button" class="btn btn-primary" onclick="guardarPersonal()">Asignar</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalRegistrarOrden" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Orden de Trabajo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalBodyRegistrarOrden">
                <!-- Aquí se cargará dinámicamente la vista parcial -->
                <div class="text-center">
                    <div class="spinner-border"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Toast de Éxito -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastExito" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toastExitoMessage">Mensaje de éxito.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Cerrar"></button>
        </div>
    </div>
</div>
<!-- Toast de Error -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastError" class="toast align-items-center text-white bg-danger border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-times-circle me-2"></i>
                <span id="toastErrorMessage">Ha ocurrido un error.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Cerrar"></button>
        </div>
    </div>
</div>
<script>
    // ===== SISTEMA DE NOTIFICACIONES OPTIMIZADO =====
    let activeToasts = new Map(); // Para rastrear toasts activos
    let toastCounter = 0; // Contador único para IDs

    function showToast(type, title, message, duration = 4000) {
        // Limpiar toasts viejos si hay más de 3
        if (activeToasts.size >= 3) {
            const oldestToast = activeToasts.keys().next().value;
            hideToast(oldestToast);
        }

        // Crear contenedor si no existe
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            container.style.cssText = `
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
            max-height: 90vh;
            overflow: hidden;
        `;
            document.body.appendChild(container);
        }

        // Iconos según el tipo
        const icons = {
            success: '<i class="fas fa-check-circle"></i>',
            error: '<i class="fas fa-exclamation-circle"></i>',
            info: '<i class="fas fa-info-circle"></i>'
        };

        // Crear ID único
        const toastId = 'toast-' + (++toastCounter);

        // Crear el toast
        const toastElement = document.createElement('div');
        toastElement.className = `toast custom-toast ${type}`;
        toastElement.setAttribute('role', 'alert');
        toastElement.setAttribute('id', toastId);
        toastElement.innerHTML = `
        <div class="toast-header ${type}">
            <span class="toast-icon">${icons[type]}</span>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
        <div class="toast-progress ${type}" style="animation-duration: ${duration}ms;"></div>
    `;

        // Agregar al contenedor
        container.appendChild(toastElement);

        // Inicializar el toast de Bootstrap
        const toastInstance = new bootstrap.Toast(toastElement, {
            delay: duration,
            autohide: true
        });

        // Registrar en el mapa de toasts activos
        activeToasts.set(toastId, {
            element: toastElement,
            instance: toastInstance,
            timer: null
        });

        // Event listeners
        toastElement.addEventListener('hide.bs.toast', function () {
            toastElement.classList.add('hiding');
        });

        toastElement.addEventListener('hidden.bs.toast', function () {
            cleanupToast(toastId);
        });

        // Mostrar el toast
        toastInstance.show();

        // Timer de limpieza
        const timer = setTimeout(() => {
            if (activeToasts.has(toastId)) {
                hideToast(toastId);
            }
        }, duration + 100);

        activeToasts.get(toastId).timer = timer;

        return toastInstance;
    }

    function hideToast(toastId) {
        const toastData = activeToasts.get(toastId);
        if (toastData) {
            // Limpiar timer
            if (toastData.timer) {
                clearTimeout(toastData.timer);
            }
            // Ocultar toast
            toastData.instance.hide();
        }
    }

    function cleanupToast(toastId) {
        const toastData = activeToasts.get(toastId);
        if (toastData) {
            // Limpiar timer
            if (toastData.timer) {
                clearTimeout(toastData.timer);
            }

            // Remover elemento del DOM
            setTimeout(() => {
                if (toastData.element.parentNode) {
                    toastData.element.remove();
                }
            }, 300);

            // Remover del mapa
            activeToasts.delete(toastId);

            // Limpiar contenedor si está vacío
            const container = document.querySelector('.toast-container');
            if (container && activeToasts.size === 0) {
                setTimeout(() => {
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 500);
            }
        }
    }

    // ===== GESTIÓN DE MODALES OPTIMIZADA =====
    let modalEventListeners = new Map();

    function addModalListener(modalId, eventType, handler) {
        const key = `${modalId}-${eventType}`;

        // Remover listener anterior si existe
        if (modalEventListeners.has(key)) {
            const modal = document.getElementById(modalId);
            const oldHandler = modalEventListeners.get(key);
            modal.removeEventListener(eventType, oldHandler);
        }

        // Agregar nuevo listener
        const modal = document.getElementById(modalId);
        modal.addEventListener(eventType, handler);
        modalEventListeners.set(key, handler);
    }

    // ===== MODAL AUTOPARTE OPTIMIZADO =====
    addModalListener('modalAutoparte', 'show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const ordenId = button.getAttribute('data-ordenid');
        document.getElementById('ordenId').value = ordenId;

        const categoriaSelect = document.getElementById('categoriaSelect');
        categoriaSelect.innerHTML = '<option value="">Selecciona una categoría</option>';

        fetch('/Personal_Servicio/GetCategorias')
            .then(response => response.json())
            .then(data => {
                data.forEach(categoria => {
                    let option = document.createElement("option");
                    option.value = categoria.id;
                    option.text = categoria.nombre;
                    categoriaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Error', 'Error al cargar las categorías.');
            });
    });

    // Event listener para categoría (solo uno)
    let categoriaChangeHandler = function () {
        const categoriaId = this.value;
        const autoparteSelect = document.getElementById("autoparteSelect");

        autoparteSelect.innerHTML = '<option value="">Selecciona una autoparte</option>';
        autoparteSelect.disabled = true;

        if (categoriaId) {
            fetch(`/Personal_Servicio/GetAutopartesPorCategoria?categoriaId=${categoriaId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(autoparte => {
                        let option = document.createElement("option");
                        option.value = autoparte.id;
                        option.text = autoparte.aut_nombre;
                        autoparteSelect.appendChild(option);
                    });
                    autoparteSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error al cargar autopartes:', error);
                    showToast('error', 'Error', 'Error al cargar las autopartes.');
                });
        }
    };

    // Remover listener anterior y agregar nuevo
    const categoriaSelect = document.getElementById("categoriaSelect");
    categoriaSelect.removeEventListener("change", categoriaChangeHandler);
    categoriaSelect.addEventListener("change", categoriaChangeHandler);

    function guardarAutoparte() {
        const ordenId = document.getElementById("ordenId").value;
        const autoparteSelect = document.getElementById("autoparteSelect");
        const autoparteId = autoparteSelect.value;
        const autoparteNombre = autoparteSelect.options[autoparteSelect.selectedIndex].text;

        if (!autoparteId) {
            showToast('error', 'Error', 'Debes seleccionar una autoparte.');
            return;
        }

        // Deshabilitar botón para evitar doble click
        const btnGuardar = document.querySelector('.btn-success[onclick="guardarAutoparte()"]');
        const originalText = btnGuardar.innerHTML;
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

        fetch("/Personal_Servicio/AsignarAutoparte", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                ordenId: parseInt(ordenId),
                autoparteId: parseInt(autoparteId)
            })
        })
            .then(response => {
                if (response.ok) {
                    showToast('success', '¡Éxito!', 'Autoparte asignada correctamente.');

                    const span = document.getElementById(`autoparte-nombre-${ordenId}`);
                    span.textContent = autoparteNombre;

                    const buttons = document.querySelectorAll(`button[data-bs-target="#modalAutoparte"][data-ordenid="${ordenId}"]`);
                    buttons.forEach(button => button.remove());

                    const modalElement = document.getElementById('modalAutoparte');
                    bootstrap.Modal.getInstance(modalElement).hide();
                } else {
                    showToast('error', 'Error', 'Error al asignar la autoparte.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Error de Conexión', 'No se pudo conectar con el servidor.');
            })
            .finally(() => {
                // Restaurar botón
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
            });
    }

    addModalListener('modalAutoparte', 'hidden.bs.modal', function () {
        document.getElementById('categoriaSelect').innerHTML = '<option value="">Selecciona una categoría</option>';
        const autoparteSelect = document.getElementById("autoparteSelect");
        autoparteSelect.innerHTML = '<option value="">Selecciona una autoparte</option>';
        autoparteSelect.disabled = true;
    });

    let modalPersonal = document.getElementById('modalPersonal');

    modalPersonal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const ordenId = button.getAttribute('data-ordenid');
        document.getElementById('ordenIdPersonal').value = ordenId;

            const personalSelect = document.getElementById('personalSelect');
            personalSelect.innerHTML = '<option value="">Cargando personal...</option>';

        // Aquí pides al backend la lista de usuarios con rol Personal_Servicio
        fetch('/Personal_Servicio/ObtenerPersonalServicio')
            .then(response => response.json())
            .then(data => {
                personalSelect.innerHTML = '<option value="">Selecciona un trabajador</option>';
                data.forEach(personal => {
                    let option = document.createElement("option");
                    option.value = personal.id;
                    option.text = personal.correo
                    personalSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar personal:', error);
                personalSelect.innerHTML = '<option value="">Error al cargar personal</option>';
            });
    });

    function guardarPersonal() {
        const ordenId = document.getElementById('ordenIdPersonal').value;
        const personalSelect = document.getElementById('personalSelect');
        const personalId = personalSelect.value;

        if (!personalId) {
            alert('Debes seleccionar un trabajador.');
            return;
        }

        // Deshabilitar botón
        const btnGuardar = document.querySelector('.btn-primary[onclick="guardarPersonal()"]');
        const originalText = btnGuardar.innerHTML;
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Asignando...';

        fetch('/Personal_Servicio/AsignarPersonal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                ordenId: parseInt(ordenId),
                personalId: personalId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`personal-nombre-${ordenId}`).textContent = data.correo;
                    bootstrap.Modal.getInstance(document.getElementById('modalPersonal')).hide();

                    // Mostrar toast con pequeño retraso para evitar conflicto con el modal
                    setTimeout(() => {
                        mostrarToastExito("Personal asignado exitosamente.");
                    }, 300);
                } else {
                    alert(data.message || 'Error al asignar el personal.');
                }
            })
            .catch(error => {
                alert('Error de red o inesperado');
                console.error(error);
            })
            .finally(() => {
                // Restaurar botón
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
            });
    }


    addModalListener('modalPersonal', 'hidden.bs.modal', function () {
        document.getElementById('personalSelect').innerHTML = '<option value="">Selecciona un trabajador</option>';
    });

    // ===== MODAL REGISTRAR ORDEN OPTIMIZADO =====
    function abrirModalRegistrarOrden() {
        const modalBody = document.getElementById("modalBodyRegistrarOrden");
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

        fetch("/Personal_Servicio/RegistrarOrdenParcial")
            .then(res => res.text())
            .then(html => {
                modalBody.innerHTML = html;
                inicializarEventosServicioReserva();
                const modal = new bootstrap.Modal(document.getElementById("modalRegistrarOrden"));
                modal.show();
            })
            .catch(err => {
                console.error("Error al cargar el formulario:", err);
                modalBody.innerHTML = '<div class="alert alert-danger">Error al cargar el formulario.</div>';
                showToast('error', 'Error', 'Error al cargar el formulario.');
            });
    }

    function inicializarEventosServicioReserva() {
        const servicioSelect = document.getElementById("servicioSelect");
        const reservaSelect = document.getElementById("reservaSelect");
        const reservaSeleccionadaInput = document.getElementById("reservaSeleccionada");
        const btnRegistrarOrden = document.getElementById("btnRegistrarOrden");
        const descripcionInput = document.getElementById("descripcionInput");

        if (!servicioSelect) return;

        // Limpiar event listeners anteriores
        servicioSelect.replaceWith(servicioSelect.cloneNode(true));
        const newServicioSelect = document.getElementById("servicioSelect");
        const newReservaSelect = document.getElementById("reservaSelect");
        const newBtnRegistrarOrden = document.getElementById("btnRegistrarOrden");

        newServicioSelect.addEventListener("change", function () {
            const servicioId = this.value;
            newReservaSelect.innerHTML = '<option value="">Cargando reservas...</option>';
            newReservaSelect.disabled = true;

            if (servicioId) {
                fetch(`/Personal_Servicio/GetReservasPorServicio?servicioId=${servicioId}`)
                    .then(res => res.json())
                    .then(data => {
                        newReservaSelect.innerHTML = data.length === 0
                            ? '<option value="">No hay reservas para este servicio</option>'
                            : '<option value="">Selecciona una reserva</option>';

                        data.forEach(reserva => {
                            const option = document.createElement("option");
                            const fecha = new Date(reserva.fecha);
                            const fechaFormateada = `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`;
                            option.value = reserva.id;
                            option.text = `Reserva ID: ${reserva.id} - Fecha: ${fechaFormateada}`;
                            newReservaSelect.appendChild(option);
                        });

                        newReservaSelect.disabled = false;
                    })
                    .catch(err => {
                        console.error("Error al cargar reservas:", err);
                        newReservaSelect.innerHTML = '<option value="">Error al cargar reservas</option>';
                        newReservaSelect.disabled = true;
                        showToast('error', 'Error', 'Error al cargar las reservas.');
                    });
            } else {
                newReservaSelect.innerHTML = '<option value="">Selecciona un servicio primero</option>';
                newReservaSelect.disabled = true;
            }
        });

        newReservaSelect.addEventListener("change", function () {
            reservaSeleccionadaInput.value = this.value;
            newBtnRegistrarOrden.disabled = !this.value;
        });

        newBtnRegistrarOrden.addEventListener("click", function () {
            const reservaId = reservaSeleccionadaInput.value;
            const descripcion = descripcionInput.value;

            if (!reservaId) {
                alert("Selecciona una reserva.");
                return;
            }

            // Deshabilitar botón
            newBtnRegistrarOrden.disabled = true;
            newBtnRegistrarOrden.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrando...';

            fetch("/Personal_Servicio/RegistrarOrden", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    ReservaId: parseInt(reservaId),
                    Descripcion: descripcion
                })
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert("Orden registrada exitosamente.");
                        bootstrap.Modal.getInstance(document.getElementById("modalRegistrarOrden")).hide();
                        location.reload();
                    } else {
                        alert(result.message || "Error al registrar la orden.");
                    }
                })
                .catch(error => {
                    alert("Error en la conexión.");
                    console.error(error);
                })
                .finally(() => {
                    newBtnRegistrarOrden.disabled = false;
                    newBtnRegistrarOrden.innerHTML = 'REGISTRAR ORDEN';
                });

        });
    }

    // ===== OPTIMIZACIÓN DE PILLS DE ESTADO =====
    let statusObserver = null;

    function convertStatusToPills() {
        const statusCells = document.querySelectorAll('.table tbody td:nth-child(5)');

        statusCells.forEach(cell => {
            // Evitar procesar celdas ya procesadas
            if (cell.querySelector('.status-pill')) return;

            const text = cell.textContent.trim();
            if (text && text !== '') {
                const pill = document.createElement('span');
                pill.className = 'status-pill';
                pill.textContent = text;

                const statusLower = text.toLowerCase();
                if (statusLower.includes('pendiente')) {
                    pill.classList.add('status-pendiente');
                } else if (statusLower.includes('confirmada')) {
                    pill.classList.add('status-confirmada');
                } else if (statusLower.includes('completada')) {
                    pill.classList.add('status-completada');
                } else if (statusLower.includes('cancelad')) {
                    pill.classList.add('status-cancelada');
                }

                cell.innerHTML = '';
                cell.appendChild(pill);
            }
        });
    }

    // ===== INICIALIZACIÓN OPTIMIZADA =====
    document.addEventListener('DOMContentLoaded', function () {
        // Convertir estados a pills
        convertStatusToPills();

        // Observer optimizado (solo uno)
        if (statusObserver) {
            statusObserver.disconnect();
        }

        statusObserver = new MutationObserver(function (mutations) {
            let shouldUpdate = false;
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    shouldUpdate = true;
                }
            });

            if (shouldUpdate) {
                setTimeout(convertStatusToPills, 100);
            }
        });

        const tableBody = document.querySelector('.table tbody');
        if (tableBody) {
            statusObserver.observe(tableBody, {
                childList: true,
                subtree: true
            });
        }
    });

    // ===== LIMPIEZA AL SALIR DE LA PÁGINA =====
    window.addEventListener('beforeunload', function () {
        // Limpiar todos los toasts activos
        activeToasts.forEach((toastData, toastId) => {
            if (toastData.timer) {
                clearTimeout(toastData.timer);
            }
        });
        activeToasts.clear();

        // Desconectar observer
        if (statusObserver) {
            statusObserver.disconnect();
        }
    });
    newBtnRegistrarOrden.addEventListener("click", function () {
        const reservaId = reservaSeleccionadaInput.value;
        const descripcion = descripcionInput.value;

        if (!reservaId) {
            showToast('error', 'Error', 'Selecciona una reserva.');
            return;
        }

        // GUARDAR dimensiones originales del botón
        const originalWidth = newBtnRegistrarOrden.offsetWidth;
        const originalHeight = newBtnRegistrarOrden.offsetHeight;
        const originalText = newBtnRegistrarOrden.innerHTML;

        // Fijar dimensiones para evitar deformación
        newBtnRegistrarOrden.style.width = originalWidth + 'px';
        newBtnRegistrarOrden.style.height = originalHeight + 'px';
        newBtnRegistrarOrden.style.minWidth = originalWidth + 'px';

        // Deshabilitar botón y cambiar contenido
        newBtnRegistrarOrden.disabled = true;
        newBtnRegistrarOrden.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch("/Personal_Servicio/RegistrarOrden", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ReservaId: parseInt(reservaId),
                Descripcion: descripcion
            })
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    // Mostrar éxito con checkmark
                    newBtnRegistrarOrden.innerHTML = '<i class="fas fa-check"></i>';
                    newBtnRegistrarOrden.style.background = 'linear-gradient(135deg, #10b981, #34d399)';

                    showToast('success', '¡Éxito!', 'Orden registrada exitosamente.');

                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById("modalRegistrarOrden")).hide();
                    }, 1000);

                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showToast('error', 'Error', result.message || 'Error al registrar la orden.');
                    // Restaurar botón en caso de error
                    restoreButton();
                }
            })
            .catch(error => {
                showToast('error', 'Error de Conexión', 'No se pudo conectar con el servidor.');
                console.error(error);
                // Restaurar botón en caso de error
                restoreButton();
            });

        // Función para restaurar el botón
        function restoreButton() {
            newBtnRegistrarOrden.disabled = false;
            newBtnRegistrarOrden.innerHTML = originalText;
            newBtnRegistrarOrden.style.width = '';
            newBtnRegistrarOrden.style.height = '';
            newBtnRegistrarOrden.style.minWidth = '';
            newBtnRegistrarOrden.style.background = '';
        }
    });
    // ===== FUNCIONALIDAD DEL BUSCADOR CON NORMALIZACIÓN DE TILDES =====
let searchTimeout;

// Función para normalizar texto (quitar tildes, acentos y caracteres especiales)
function normalizeText(text) {
    return text
        .toLowerCase()
        .normalize('NFD')                    // Descomponer caracteres con tildes
        .replace(/[\u0300-\u036f]/g, '')     // Eliminar marcas diacríticas (tildes, acentos)
        .replace(/[ñ]/g, 'n')                // Opcional: convertir ñ a n
        .trim();
}

// Inicialización cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function () {
    initializeSearch();
});

function initializeSearch() {
    const searchInput = document.getElementById('searchInput');

    if (!searchInput) {
        console.error('No se encontró el elemento de búsqueda');
        return;
    }

    console.log('Buscador inicializado correctamente');

    // Event listeners para el input
    searchInput.addEventListener('input', function () {
        handleSearch();
    });

    searchInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearchImmediate();
        }
    });

    // Atajos de teclado
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
            searchInput.select();
        }

        if (e.key === 'Escape' && document.activeElement === searchInput) {
            clearSearch();
        }
    });

    // Auto-focus después de cargar
    setTimeout(() => {
        searchInput.focus();
    }, 500);
}

function handleSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;

    clearTimeout(searchTimeout);

    // Búsqueda inmediata si está vacío
    if (searchInput.value.trim() === '') {
        performSearchImmediate();
        return;
    }

    // Debounce para búsquedas con texto
    searchTimeout = setTimeout(() => {
        performSearchImmediate();
    }, 300);
}

// FUNCIÓN PRINCIPAL DE BÚSQUEDA - CON NORMALIZACIÓN DE TILDES
function performSearchImmediate() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;

    const searchTerm = searchInput.value.trim();
    const normalizedSearchTerm = normalizeText(searchTerm);
    const tableRows = document.querySelectorAll('.table tbody tr');
    let visibleCount = 0;

    // Limpiar highlights anteriores
    clearHighlights();

    console.log(`Buscando: "${searchTerm}" (normalizado: "${normalizedSearchTerm}")`);

    tableRows.forEach((row, index) => {
        if (searchTerm === '') {
            // Mostrar todas las filas si no hay búsqueda
            row.style.display = '';
            visibleCount++;
            return;
        }

        // Buscar en todas las celdas de la fila
        let found = false;
        const cells = row.querySelectorAll('td');
        
        cells.forEach((cell, cellIndex) => {
            // Saltar la columna del PDF (última columna)
            if (cellIndex === cells.length - 1) return;
            
            const cellText = extractCellText(cell, cellIndex);
            const normalizedCellText = normalizeText(cellText);
            
            // Comparar textos normalizados (sin tildes)
            if (normalizedCellText.includes(normalizedSearchTerm)) {
                found = true;
                highlightTextInCell(cell, searchTerm, cellIndex, cellText);
                console.log(`✓ Encontrado en fila ${index + 1}, celda ${cellIndex + 1}: "${cellText}" (normalizado: "${normalizedCellText}")`);
            }
        });

        // Mostrar u ocultar la fila
        if (found) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Actualizar resultados
    updateSearchResults(visibleCount, tableRows.length, searchTerm);
    
    console.log(`Búsqueda completada: ${visibleCount}/${tableRows.length} resultados`);
}

function extractCellText(cell, cellIndex) {
    let text = '';

    switch (cellIndex) {
        case 0: // ID
        case 1: // Servicio
        case 2: // Reserva-Placa
        case 3: // Cliente
        case 7: // Descripción
            text = cell.textContent.trim();
            break;
            
        case 4: // Estado
            const statusPill = cell.querySelector('.status-pill');
            text = statusPill ? statusPill.textContent.trim() : cell.textContent.trim();
            break;
            
        case 5: // Personal
            const personalSpan = cell.querySelector('span[id^="personal-nombre-"]');
            text = personalSpan ? personalSpan.textContent.trim() : getTextWithoutButtons(cell);
            break;
            
        case 6: // Autoparte
            const autoparteSpan = cell.querySelector('span[id^="autoparte-nombre-"]');
            text = autoparteSpan ? autoparteSpan.textContent.trim() : getTextWithoutButtons(cell);
            break;
            
        default:
            text = getTextWithoutButtons(cell);
    }

    return text;
}

function getTextWithoutButtons(cell) {
    const clone = cell.cloneNode(true);
    const buttons = clone.querySelectorAll('button, a, .btn, i');
    buttons.forEach(btn => btn.remove());
    return clone.textContent.trim();
}

// HIGHLIGHT MEJORADO - BUSCA LA COINCIDENCIA REAL EN EL TEXTO ORIGINAL
function highlightTextInCell(cell, searchTerm, cellIndex, originalText) {
    const target = getTargetElement(cell, cellIndex);
    if (target) {
        highlightInElement(target, searchTerm, originalText);
    }
}

function getTargetElement(cell, cellIndex) {
    switch (cellIndex) {
        case 4: // Estado
            return cell.querySelector('.status-pill') || cell;
        case 5: // Personal
            return cell.querySelector('span[id^="personal-nombre-"]') || cell;
        case 6: // Autoparte
            return cell.querySelector('span[id^="autoparte-nombre-"]') || cell;
        default:
            return cell;
    }
}

function highlightInElement(element, searchTerm, originalText) {
    const text = originalText || element.textContent;
    const normalizedText = normalizeText(text);
    const normalizedSearchTerm = normalizeText(searchTerm);
    
    // Encontrar la posición en el texto normalizado
    const index = normalizedText.indexOf(normalizedSearchTerm);
    
    if (index !== -1 && !element.querySelector('.highlight')) {
        // Usar la posición para destacar en el texto original
        const beforeText = text.substring(0, index);
        const matchText = text.substring(index, index + normalizedSearchTerm.length);
        const afterText = text.substring(index + normalizedSearchTerm.length);

        element.innerHTML = beforeText +
            '<mark class="highlight">' + matchText + '</mark>' +
            afterText;
    }
}

function clearHighlights() {
    const highlights = document.querySelectorAll('.highlight');
    highlights.forEach(highlight => {
        const parent = highlight.parentNode;
        if (parent) {
            parent.textContent = parent.textContent; // Esto elimina todo el HTML interno
        }
    });
}

function updateSearchResults(visible, total, searchTerm) {
    const searchResults = document.getElementById('searchResults');
    const noResults = document.getElementById('noResults');

    if (!searchResults || !noResults) return;

    if (searchTerm === '') {
        searchResults.classList.remove('show');
        noResults.classList.remove('show');
        return;
    }

    if (visible === 0) {
        searchResults.classList.remove('show');
        noResults.classList.add('show');
    } else {
        noResults.classList.remove('show');
        searchResults.innerHTML = `
            Se encontr${visible === 1 ? 'ó' : 'aron'} 
            <span class="count">${visible}</span> 
            ${visible === 1 ? 'orden' : 'órdenes'} 
            de trabajo${visible > 1 ? 's' : ''} 
            de ${total} total${total > 1 ? 'es' : ''}
        `;
        searchResults.classList.add('show');
    }
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const noResults = document.getElementById('noResults');

    if (!searchInput) return;

    searchInput.value = '';
    clearHighlights();

    // Mostrar todas las filas
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => row.style.display = '');

    // Ocultar resultados
    if (searchResults) searchResults.classList.remove('show');
    if (noResults) noResults.classList.remove('show');

    searchInput.focus();
    console.log('Búsqueda limpiada');
}

// Función global para testing
window.testSearch = function (term) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = term;
        performSearchImmediate();
    }
};

// Función para testing de normalización
window.testNormalize = function (text) {
    console.log(`Original: "${text}"`);
    console.log(`Normalizado: "${normalizeText(text)}"`);
    return normalizeText(text);
};
</script>
