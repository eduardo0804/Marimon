@model Tuple<Marimon.Models.Usuario, List<Marimon.Models.Carrito.CarritoItem>>
@inject Microsoft.Extensions.Options.IOptions<Marimon.Models.StripeSettings> StripeSettings

@{
    var usuario = Model.Item1;
    var carrito = Model.Item2;
    var total = carrito.Sum(p => p.PrecioUnitario * p.Cantidad);
    Layout = "_LayoutPago";
    ViewData["Title"] = "Finaliza tu Compra - Marimon";
}
@section Styles {
    <link rel="stylesheet" href="~/css/comproYS.css" asp-append-version="true" />
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<form id="miFormulario" action="@Url.Action("ProcesarPago", "Comprobante")" method="post" class="needs-validation"
    novalidate>
    <div class="container py-5">
        <!-- Cabecera -->
        <div class="row checkout-header animated-card" style="animation-delay: 0.1s;">
            <div class="col-lg-7 mb-3 mb-lg-0">
                <div class="d-flex align-items-center">
                    <a href="@Url.Action("Index", "Carrito")" class="back-btn me-3">
                        <i class="bi bi-arrow-left-circle-fill"></i>
                    </a>
                    <h2 class="fw-bold text-dark mb-0">Finaliza tu Compra</h2>
                </div>
            </div>
            <div class="col-lg-5 d-flex justify-content-lg-end justify-content-center">
                <div class="secure-badge">
                    <i class="bi bi-shield-check fs-5"></i>
                    <span>Compra 100% Segura</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Resumen de Pedido (Order Summary) -->
            <div class="col-lg-5 order-lg-2">
                <div class="card p-4 order-summary animated-card" style="animation-delay: 0.2s;">
                    <div class="summary-header">
                        <h3 class="summary-title">Resumen de Pedido</h3>
                    </div>

                    <div class="summary-items" style="max-height: 380px; overflow-y: auto;">
                        @foreach (var item in carrito)
                        {
                            <div class="cart-item">
                                <div class="item-image">
                                    @if (!string.IsNullOrEmpty(item.ImagenUrl))
                                    {
                                        <img src="@item.ImagenUrl" alt="@item.Nombre">
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-content-center align-items-center h-100 bg-light">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </div>
                                <div class="item-info">
                                    <div class="item-name">@item.Nombre</div>
                                    <div class="item-quantity">Cantidad: @item.Cantidad</div>
                                </div>
                                <div class="item-price">
                                    S/@String.Format("{0:0.00}", item.PrecioUnitario * item.Cantidad)
                                </div>
                            </div>
                        }
                    </div>

                    <div class="" style="margin-top: 10px;">
                        <strong class="">TOTAL:</strong>
                        <strong class="">S/@String.Format("{0:0.00}", total)</strong>
                    </div>
                </div>
            </div>
            <!-- Formulario principal -->
            <div class="col-lg-7 order-lg-1">
                <!-- Tipo de comprobante -->
                <div class="card p-4 mb-4 animated-card" style="animation-delay: 0.3s;">
                    <h4 class="text-center fw-bold mb-4">Selecciona el Tipo de Comprobante</h4>
                    <div class="custom-radio-container">
                        <div class="custom-radio-btn">
                            <input type="radio" id="boleta" name="tipoComprobante" value="boleta" checked>
                            <label for="boleta">
                                <i class="bi bi-receipt text-dark fs-2"></i> <!-- Boleta -->
                                <span class="option-title">Boleta</span>
                                <small class="text-muted mt-2">Para personas naturales</small>
                            </label>
                        </div>

                        <div class="custom-radio-btn">
                            <input type="radio" id="factura" name="tipoComprobante" value="factura">
                            <label for="factura">
                                <i class="bi bi-file-earmark-text text-dark fs-2"></i> <!-- Factura -->
                                <span class="option-title">Factura</span>
                                <small class="text-muted mt-2">Para empresas o negocios</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Datos para Boleta -->
                <div id="camposBoleta" class="card p-4 mb-4 animated-card" style="animation-delay: 0.4s;">
                    <h4 class="fw-bold mb-4">Datos Personales</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" name="usu_nombre"
                                value="@usuario.usu_nombre" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidos" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidos" name="usu_apellido"
                                value="@usuario.usu_apellido" readonly>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="tipoDocumento" class="form-label">Tipo de Documento *</label>
                            <select class="form-select" id="tipoDocumento" name="tipoDocumento" required>
                                <option selected disabled value="">Seleccione</option>
                                <option value="DNI">DNI</option>
                                <option value="CE">Carnet de Extranjería</option>
                                <option value="Pasaporte">Pasaporte</option>
                            </select>
                            <div class="invalid-feedback">
                                Seleccione un tipo de documento válido.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="numeroDocumento" class="form-label">N° de Documento *</label>
                            <input type="text" class="form-control" id="numeroDocumento" name="num_identificacion"
                                placeholder="Ingrese su número de documento" required
                                pattern="^\d{8}$|^\d{9}$|^[A-Z0-9]{6,12}$">
                            <div class="invalid-feedback">
                                Ingrese un número válido: DNI (8 dígitos), CE (9 dígitos), Pasaporte (6-12 caracteres)
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="correo" class="form-label">Correo Electrónico *</label>
                            <input type="email" class="form-control" id="correo" name="usu_correo"
                                value="@usuario.usu_correo" readonly>
                        </div>
                    </div>
                </div>

                <!-- Datos para Factura -->
                <div id="camposFactura" class="card p-4 mb-4 animated-card"
                    style="display: none; animation-delay: 0.4s;">
                    <h4 class="fw-bold mb-4">Datos de Facturación</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombreFactura" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombreFactura" name="usu_nombre"
                                value="@usuario.usu_nombre" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidosFactura" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidosFactura" name="usu_apellido"
                                value="@usuario.usu_apellido" readonly>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="correoFactura" class="form-label">Correo Electrónico *</label>
                            <input type="email" class="form-control" id="correoFactura" name="usu_correo"
                                value="@usuario.usu_correo" readonly>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="razonSocial" class="form-label">Razón Social *</label>
                            <input type="text" class="form-control" id="razonSocial" name="fac_razonsocial"
                                placeholder="Ingrese razón social" required
                                pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-]{3,100}$">
                            <div class="invalid-feedback">
                                Ingrese una razón social válida (mínimo 3 caracteres)
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="ruc" class="form-label">N° de R.U.C. *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-secondary-subtle">
                                    <i class="bi bi-building"></i>
                                </span>
                                <input type="text" class="form-control" id="ruc" name="fac_ruc"
                                    placeholder="Ingrese número de RUC" required pattern="^\d{11}$">
                                <div class="invalid-feedback">
                                    El RUC debe contener exactamente 11 dígitos numéricos
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="direccion" class="form-label">Dirección Fiscal o Comercial *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-secondary-subtle">
                                    <i class="bi bi-geo-alt"></i>
                                </span>
                                <input type="text" class="form-control" id="direccion" name="fac_direccion"
                                    placeholder="Ingrese dirección fiscal completa" required
                                    pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-\#]{5,150}$">
                                <div class="invalid-feedback">
                                    Ingrese una dirección válida (mínimo 5 caracteres)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entrega -->
                <div class="card pickup-card p-4 mb-4 animated-card" style="animation-delay: 0.5s;">
                    <div class="pickup-content d-flex align-items-start">
                        <div class="pickup-icon">
                            <i class="bi bi-shop"></i>
                        </div>
                        <div>
                            <h5 class="pickup-title">Entrega en Tienda</h5>
                            <p class="pickup-address">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                Jr. Gral. Felipe Santiago Salaverry 44, Lima 15022
                            </p>
                            <span class="badge bg-success mt-2">
                                <i class="bi bi-check-circle-fill me-1"></i> Disponible para recojo
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Método de pago -->
                <div class="card p-4 mb-4 animated-card" style="animation-delay: 0.6s;">
                    <h4 class="text-center fw-bold mb-4">Selecciona el Método de Pago</h4>

                    <div class="custom-radio-container">
                        <div class="custom-radio-btn">
                            <input type="radio" id="pagoTarjeta" name="metodoPago" value="tarjeta" checked>
                            <label for="pagoTarjeta">
                                <div class="d-flex gap-2">
                                    <i class="bi bi-credit-card-2-front fs-2"></i>
                                    <i class="bi bi-credit-card fs-2"></i>
                                </div>
                                <span class="option-title text-center">Tarjeta de Crédito/Débito</span>
                            </label>
                        </div>

                        <div class="custom-radio-btn">
                            <input type="radio" id="pagoYape" name="metodoPago" value="yape">
                            <label for="pagoYape">
                                <div class="d-flex gap-2">
                                    <i class="bi bi-bank fs-2"></i>
                                    <i class="bi bi-phone-fill fs-2"></i>
                                </div>
                                <span class="option-title text-center">Yape + Depósito Bancario</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Nota -->
                <div class="note-alert alert animated-card" style="animation-delay: 0.7s;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-3 me-3 text-warning"></i>
                        <div class="alert alert-warning" role="alert">
                            <strong>Importante:</strong> En este momento no contamos con servicio de envío a domicilio.
                            Todas las compras deben ser recogidas en tienda física.
                        </div>

                    </div>
                </div>
                <!-- Términos y condiciones -->
                <div class="mb-4 animated-card" style="animation-delay: 0.75s;">
                    <div class="mt-2 terms-container">
                        <div class="terms-check">
                            <div class="custom-checkbox" id="customCheckbox"></div>
                            <input type="checkbox" class="form-check-input" id="aceptaTerminos" name="aceptaTerminos"
                                required style="display: none;">
                            <div class="terms-text">
                                He leído y acepto los
                                <a href="@Url.Action("Terminos", "Home")" target="_blank" class="terms-link">
                                    Términos y Condiciones
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Botón para Stripe -->
                <div id="botonStripe" class="text-center animated-card">
                    <button type="submit" class="btn btn-marimon">
                        <i class="bi bi-credit-card-fill me-2"></i>Pagar con Tarjeta
                    </button>
                </div>

                <!-- Botón para Yape -->
                <div id="botonYape" class="text-center mb-5 animated-card" style="display: none;">
                    <button type="submit" class="btn btn-marimon">
                        <i class="bi bi-phone-fill me-2"></i>Pagar con Yape o Transferencia
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
<script src="~/js/comprobante.js" asp-append-version="true"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Checkbox personalizado para términos y condiciones
        const customCheckbox = document.getElementById('customCheckbox');
        const aceptaTerminos = document.getElementById('aceptaTerminos');

        if (customCheckbox && aceptaTerminos) {
            customCheckbox.addEventListener('click', function () {
                aceptaTerminos.checked = !aceptaTerminos.checked;

                if (aceptaTerminos.checked) {
                    this.classList.add('checked');
                } else {
                    this.classList.remove('checked');
                }
            });

            // Add ripple effect to custom checkbox
            let ripple = document.createElement('span');
            ripple.classList.add('ripple');
            customCheckbox.appendChild(ripple);

            customCheckbox.addEventListener('mousedown', function (e) {
                const x = e.clientX - e.target.getBoundingClientRect().left;
                const y = e.clientY - e.target.getBoundingClientRect().top;

                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.classList.add('animate');

                setTimeout(() => {
                    ripple.classList.remove('animate');
                }, 500);
            });
        }

        // Validación del formulario
        const formulario = document.getElementById('miFormulario');
        if (formulario) {
            formulario.addEventListener('submit', function (event) {
                var esValido = true;

                // Detectar tipo de comprobante
                var tipoComprobante = formulario.querySelector('input[name="tipoComprobante"]:checked').value;

                if (tipoComprobante === 'boleta') {
                    var tipoDocumento = formulario.querySelector('#tipoDocumento').value;
                    var numeroDocumento = formulario.querySelector('#numeroDocumento');
                    var numeroDocumentoValue = numeroDocumento.value.trim();

                    // Limpiar errores previos
                    numeroDocumento.classList.remove('is-invalid');

                    // Validación por tipo de documento
                    if (tipoDocumento === 'DNI') {
                        if (!/^\d{8}$/.test(numeroDocumentoValue)) {
                            numeroDocumento.classList.add('is-invalid');
                            esValido = false;
                        }
                    } else if (tipoDocumento === 'CE') {
                        if (!/^\d{9}$/.test(numeroDocumentoValue)) {
                            numeroDocumento.classList.add('is-invalid');
                            esValido = false;
                        }
                    } else if (tipoDocumento === 'Pasaporte') {
                        if (!/^[A-Z0-9]{6,12}$/.test(numeroDocumentoValue)) {
                            numeroDocumento.classList.add('is-invalid');
                            esValido = false;
                        }
                    }

                    if (tipoDocumento === '') {
                        formulario.querySelector('#tipoDocumento').classList.add('is-invalid');
                        esValido = false;
                    } else {
                        formulario.querySelector('#tipoDocumento').classList.remove('is-invalid');
                    }

                } else if (tipoComprobante === 'factura') {
                    // Validaciones para factura
                    var ruc = formulario.querySelector('#ruc');
                    var razonSocial = formulario.querySelector('#razonSocial');
                    var direccion = formulario.querySelector('#direccion');

                    ruc.classList.remove('is-invalid');
                    razonSocial.classList.remove('is-invalid');
                    direccion.classList.remove('is-invalid');

                    if (!/^\d{11}$/.test(ruc.value.trim())) {
                        ruc.classList.add('is-invalid');
                        esValido = false;
                    }

                    if (!/^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-]{3,100}$/.test(razonSocial.value.trim())) {
                        razonSocial.classList.add('is-invalid');
                        esValido = false;
                    }

                    if (!/^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-\#]{5,150}$/.test(direccion.value.trim())) {
                        direccion.classList.add('is-invalid');
                        esValido = false;
                    }
                }

                // VALIDACIÓN DE TÉRMINOS Y CONDICIONES
                if (!document.getElementById('aceptaTerminos').checked) {
                    document.querySelector('.terms-container').classList.add('shake');
                    setTimeout(() => {
                        document.querySelector('.terms-container').classList.remove('shake');
                    }, 600);
                    esValido = false;

                    // Mostrar mensaje de error
                    alert('Debe aceptar los términos y condiciones para continuar');
                }

                // Solo prevenir el envío si NO es válido
                if (!esValido) {
                    event.preventDefault();
                }
                // Si es válido, el formulario se enviará normalmente
            });
        }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
