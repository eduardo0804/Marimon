@model Tuple<Marimon.Models.Usuario, List<Marimon.Models.Carrito.CarritoItem>>
@inject Microsoft.Extensions.Options.IOptions<Marimon.Models.StripeSettings> StripeSettings

@{
    var usuario = Model.Item1;
    var carrito = Model.Item2;
    var total = carrito.Sum(p => p.PrecioUnitario * p.Cantidad);
    Layout = "_LayoutPago";
    ViewData["Title"] = "Finaliza tu Compra - Marimon";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<form id="miFormulario" action="@Url.Action("ProcesarPago", "Comprobante")" method="post" class="needs-validation"
    novalidate>
    <div class="container py-5">
        <!-- Cabecera -->
        <div class="row checkout-header animated-card" style="animation-delay: 0.1s;">
            <div class="col-lg-7 mb-3 mb-lg-0">
                <div class="d-flex align-items-center">
                    <a href="@Url.Action("Index", "Carrito")" class="back-btn me-3">
                        <i class="bi bi-arrow-left-circle-fill"></i>
                    </a>
                    <h2 class="fw-bold text-dark mb-0">Finaliza tu Compra</h2>
                </div>
            </div>
            <div class="col-lg-5 d-flex justify-content-lg-end justify-content-center">
                <div class="secure-badge">
                    <i class="bi bi-shield-check fs-5"></i>
                    <span>Compra 100% Segura</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Resumen de Pedido (Order Summary) -->
            <div class="col-lg-5 order-lg-2">
                <div class="card p-4 order-summary animated-card" style="animation-delay: 0.2s;">
                    <div class="summary-header">
                        <h3 class="summary-title">Resumen de Pedido</h3>
                    </div>

                    <div class="summary-items" style="max-height: 380px; overflow-y: auto;">
                        @foreach (var item in carrito)
                        {
                            <div class="cart-item">
                                <div class="item-image">
                                    @if (!string.IsNullOrEmpty(item.ImagenUrl))
                                    {
                                        <img src="@item.ImagenUrl" alt="@item.Nombre">
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-content-center align-items-center h-100 bg-light">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </div>
                                <div class="item-info">
                                    <div class="item-name">@item.Nombre</div>
                                    <div class="item-quantity">Cantidad: @item.Cantidad</div>
                                </div>
                                <div class="item-price">
                                    S/.@String.Format("{0:0.00}", item.PrecioUnitario * item.Cantidad)
                                </div>
                            </div>
                        }
                    </div>

                    <div class="">
                        <span class="">TOTAL:</span>
                        <span class="">S/.@String.Format("{0:0.00}", total)</span>
                        <!-- DISEÑA ZORRA -->
                    </div>
                </div>
            </div>
            <!-- Formulario principal -->
            <div class="col-lg-7 order-lg-1">
                <!-- Tipo de comprobante -->
                <div class="card p-4 mb-4 animated-card" style="animation-delay: 0.3s;">
                    <h4 class="text-center fw-bold mb-4">Selecciona el Tipo de Comprobante</h4>
                    <div class="custom-radio-container">
                        <div class="custom-radio-btn">
                            <input type="radio" id="boleta" name="tipoComprobante" value="boleta" checked>
                            <label for="boleta">
                                <i class="bi bi-receipt text-dark fs-2"></i> <!-- Boleta -->
                                <span class="option-title">Boleta</span>
                                <small class="text-muted mt-2">Para personas naturales</small>
                            </label>
                        </div>

                        <div class="custom-radio-btn">
                            <input type="radio" id="factura" name="tipoComprobante" value="factura">
                            <label for="factura">
                                <i class="bi bi-file-earmark-text text-dark fs-2"></i> <!-- Factura -->
                                <span class="option-title">Factura</span>
                                <small class="text-muted mt-2">Para empresas o negocios</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Datos para Boleta -->
                <div id="camposBoleta" class="card p-4 mb-4 animated-card" style="animation-delay: 0.4s;">
                    <h4 class="fw-bold mb-4">Datos Personales</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" name="usu_nombre"
                                value="@usuario.usu_nombre" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidos" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidos" name="usu_apellido"
                                value="@usuario.usu_apellido" readonly>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="tipoDocumento" class="form-label">Tipo de Documento *</label>
                            <select class="form-select" id="tipoDocumento" name="tipoDocumento" required>
                                <option selected disabled value="">Seleccione</option>
                                <option value="DNI">DNI</option>
                                <option value="CE">Carnet de Extranjería</option>
                                <option value="Pasaporte">Pasaporte</option>
                            </select>
                            <div class="invalid-feedback">
                                Seleccione un tipo de documento válido.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="numeroDocumento" class="form-label">N° de Documento *</label>
                            <input type="text" class="form-control" id="numeroDocumento" name="num_identificacion"
                                placeholder="Ingrese su número de documento" required
                                pattern="^\d{8}$|^\d{9}$|^[A-Z0-9]{6,12}$">
                            <div class="invalid-feedback" id="dniErrorMessage">
                                El DNI debe ser de 8 dígitos.
                            </div>
                            <div class="invalid-feedback" id="ceErrorMessage">
                                El Carnet de Extranjería debe ser de 9 dígitos.
                            </div>
                            <div class="invalid-feedback" id="pasaporteErrorMessage">
                                El Pasaporte debe ser entre 6 y 12 caracteres alfanuméricos.
                            </div>
                        </div>    
                        <div class="col-12">
                            <label for="correo" class="form-label">Correo Electrónico *</label>
                            <input type="email" class="form-control" id="correo" name="usu_correo"
                                value="@usuario.usu_correo" readonly>
                        </div>
                    </div>
                </div>

                <!-- Datos para Factura -->
                <div id="camposFactura" class="card p-4 mb-4 animated-card"
                    style="display: none; animation-delay: 0.4s;">
                    <h4 class="fw-bold mb-4">Datos de Facturación</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombreFactura" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombreFactura" name="usu_nombre"
                                value="@usuario.usu_nombre" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidosFactura" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidosFactura" name="usu_apellido"
                                value="@usuario.usu_apellido" readonly>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="correoFactura" class="form-label">Correo Electrónico *</label>
                            <input type="email" class="form-control" id="correoFactura" name="usu_correo"
                                value="@usuario.usu_correo" readonly>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="razonSocial" class="form-label">Razón Social *</label>
                            <input type="text" class="form-control" id="razonSocial" name="fac_razonsocial"
                                placeholder="Ingrese razón social" required
                                pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-]{3,100}$">
                            <div class="invalid-feedback">
                                Ingrese una razón social válida (mínimo 3 caracteres)
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="ruc" class="form-label">N° de R.U.C. *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-secondary-subtle">
                                    <i class="bi bi-building"></i>
                                </span>
                                <input type="text" class="form-control" id="ruc" name="fac_ruc"
                                    placeholder="Ingrese número de RUC" required pattern="^\d{11}$">
                                <div class="invalid-feedback">
                                    El RUC debe contener exactamente 11 dígitos numéricos
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="direccion" class="form-label">Dirección Fiscal o Comercial *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-secondary-subtle">
                                    <i class="bi bi-geo-alt"></i>
                                </span>
                                <input type="text" class="form-control" id="direccion" name="fac_direccion"
                                    placeholder="Ingrese dirección fiscal completa" required
                                    pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-\#]{5,150}$">
                                <div class="invalid-feedback">
                                    Ingrese una dirección válida (mínimo 5 caracteres)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entrega -->
                <div class="card pickup-card p-4 mb-4 animated-card" style="animation-delay: 0.5s;">
                    <div class="pickup-content d-flex align-items-start">
                        <div class="pickup-icon">
                            <i class="bi bi-shop"></i>
                        </div>
                        <div>
                            <h5 class="pickup-title">Entrega en Tienda</h5>
                            <p class="pickup-address">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                Jr. Gral. Felipe Santiago Salaverry 44, Lima 15022
                            </p>
                            <span class="badge bg-success mt-2">
                                <i class="bi bi-check-circle-fill me-1"></i> Disponible para recojo
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Método de pago -->
                <div class="card p-4 mb-4 animated-card" style="animation-delay: 0.6s;">
                    <h4 class="text-center fw-bold mb-4">Selecciona el Método de Pago</h4>

                    <div class="custom-radio-container">
                        <div class="custom-radio-btn">
                            <input type="radio" id="pagoTarjeta" name="metodoPago" value="tarjeta" checked>
                            <label for="pagoTarjeta">
                                <i class="bi bi-credit-card text-dark fs-2"></i> <!-- Tarjeta -->
                                <span class="option-title">Tarjeta de Crédito/Débito</span>
                                <div class="d-flex gap-2 mt-3">
                                    <i class="bi bi-credit-card-2-front fs-5"></i>
                                    <i class="bi bi-credit-card fs-5"></i>
                                </div>
                            </label>
                        </div>

                        <div class="custom-radio-btn">
                            <input type="radio" id="pagoYape" name="metodoPago" value="yape">
                            <label for="pagoYape">
                                <i class="bi bi-bank text-dark fs-2"></i> <!-- Banco/Yape -->
                                <span class="option-title">Yape + Depósito Bancario</span>
                                <div class="d-flex gap-2 mt-3">
                                    <i class="bi bi-bank fs-5"></i>
                                    <i class="bi bi-phone-fill fs-5"></i>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Nota -->
                <div class="note-alert alert p-3 mb-4 animated-card" style="animation-delay: 0.7s;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-3 me-3 text-warning"></i>
                        <div class="alert alert-warning" role="alert">
                            <strong>Nota importante:</strong> De momento no hay servicio de envío a domicilio, solo
                            recojo en tienda.
                        </div>

                    </div>
                </div>

                <!-- Botón para Stripe -->
                <div id="botonStripe" class="text-center mb-5 animated-card" style="animation-delay: 0.8s;">
                    <button type="submit" class="btn btn-marimon">
                        <i class="bi bi-credit-card-fill me-2"></i>CONTINUAR CON EL PAGO
                    </button>
                </div>

                <!-- Botón para Yape -->
                <div id="botonYape" class="text-center mb-5" style="display: none; animation-delay: 0.8s;">
                    <button type="submit" class="btn btn-marimon">
                        <i class="bi bi-phone-fill me-2"></i>CONTINUAR CON EL PAGO
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
<script src="~/js/comprobante.js" asp-append-version="true"></script>

<script>
document.getElementById('miFormulario').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevenir el envío inicialmente

    var formulario = this;
    var esValido = true;

    // Detectar tipo de comprobante
    var tipoComprobante = formulario.querySelector('input[name="tipoComprobante"]:checked').value;

    if (tipoComprobante === 'boleta') {
        var tipoDocumento = formulario.querySelector('#tipoDocumento').value;
        var numeroDocumento = formulario.querySelector('#numeroDocumento');
        var numeroDocumentoValue = numeroDocumento.value.trim();

        // Limpiar errores previos
        document.getElementById('dniErrorMessage').style.display = 'none';
        document.getElementById('ceErrorMessage').style.display = 'none';
        document.getElementById('pasaporteErrorMessage').style.display = 'none';
        numeroDocumento.classList.remove('is-invalid');

        // Validación por tipo de documento
        if (tipoDocumento === 'DNI') {
            if (!/^\d{8}$/.test(numeroDocumentoValue)) {
                numeroDocumento.classList.add('is-invalid');
                document.getElementById('dniErrorMessage').style.display = 'block';
                esValido = false;
            }
        } else if (tipoDocumento === 'CE') {
            if (!/^\d{9}$/.test(numeroDocumentoValue)) {
                numeroDocumento.classList.add('is-invalid');
                document.getElementById('ceErrorMessage').style.display = 'block';
                esValido = false;
            }
        } else if (tipoDocumento === 'Pasaporte') {
            if (!/^[A-Z0-9]{6,12}$/.test(numeroDocumentoValue)) {
                numeroDocumento.classList.add('is-invalid');
                document.getElementById('pasaporteErrorMessage').style.display = 'block';
                esValido = false;
            }
        }

        if (tipoDocumento === '') {
            formulario.querySelector('#tipoDocumento').classList.add('is-invalid');
            esValido = false;
        } else {
            formulario.querySelector('#tipoDocumento').classList.remove('is-invalid');
        }

    } else if (tipoComprobante === 'factura') {
        // Validaciones para factura
        var ruc = formulario.querySelector('#ruc');
        var razonSocial = formulario.querySelector('#razonSocial');
        var direccion = formulario.querySelector('#direccion');

        ruc.classList.remove('is-invalid');
        razonSocial.classList.remove('is-invalid');
        direccion.classList.remove('is-invalid');

        if (!/^\d{11}$/.test(ruc.value.trim())) {
            ruc.classList.add('is-invalid');
            esValido = false;
        }

        if (!/^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-]{3,100}$/.test(razonSocial.value.trim())) {
            razonSocial.classList.add('is-invalid');
            esValido = false;
        }

        if (!/^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s\.\,\-\#]{5,150}$/.test(direccion.value.trim())) {
            direccion.classList.add('is-invalid');
            esValido = false;
        }
    }

    // Enviar si es válido
    if (esValido) {
        formulario.submit();
    }
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
