@model Marimon.Models.Servicio
@using System.Dynamic
@{
    var resenias = ViewBag.Resenias as List<dynamic> ?? new List<dynamic>();
    var usuarioId = ViewBag.UsuarioId as string ?? "";
}
@{
    ViewBag.Title = "Servicios";
    ViewBag.FullWidthLayout = true;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var usuarioAutenticado = ViewBag.UsuarioAutenticado as bool? ?? false;
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/css/intlTelInput.min.css" />
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/intlTelInput.min.js"></script>
<link rel="stylesheet" href="~/css/home.css">
<link rel="stylesheet" href="~/css/reseñaservicio.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
    .container {
        padding: 0;
        margin: 0;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
</style>

@if (TempData["ReservaExitosa"] != null)
{
    <div class="alert alert-success success-message position-fixed" role="alert">
        <strong>Éxito</strong>: ¡Reserva realizada con éxito!
        <button type="button" class="btn-close" aria-label="Close" onclick="this.parentElement.remove();"></button>
    </div>
}

<div class="modal fade" id="errorReservaModal" tabindex="-1" aria-labelledby="errorReservaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorReservaModalLabel">Error en la Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <span id="errorReservaMensaje"></span>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Calendario -->
<div class="modal fade" id="calendarioModal" tabindex="-1" aria-labelledby="calendarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarioModalLabel">¡Reserva exitosa!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p>¿Deseas agregar tu cita a tu calendario?</p>
                <a id="googleCalendarLink" href="#" target="_blank" class="btn btn-success mb-2 w-100">Agregar a Google
                    Calendar</a>
                <a id="outlookCalendarLink" href="#" target="_blank" class="btn btn-primary w-100">Agregar a Outlook
                    Calendar</a>
            </div>
        </div>
    </div>
</div>

<!-- Banner -->
<div class="container-fluid p-0 position-relative" style="height: 350px; overflow: hidden;">
    <img src="https://firebasestorage.googleapis.com/v0/b/marimonapp.appspot.com/o/Assest_web%2Fimg-galeria-01.jpg?alt=media&token=8119fed0-1123-40cb-81b1-a2d9ce3e4b81"
        alt="Banner" class="img-fluid w-100 h-100" style="object-fit: cover; filter: brightness(0.6);" />
    <div class="banner-overlay position-absolute top-0 start-0 w-100 h-100"
        style="background: linear-gradient(180deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.8) 100%);">
    </div>
    <div class="banner-text position-absolute top-50 start-50 translate-middle text-center text-white"
        data-aos="fade-down">
        <h4 class="text-uppercase fw-bold fs-7 mb-2" style="letter-spacing:2px;">
            EXPERTOS EN TU VEHÍCULO
        </h4>
        <h2 class="fw-bold fs-2">
            ¡Tu Tranquilidad Es Nuestra Prioridad!<br>
            <span style="color:#ff9d00;">Años de Experiencia Comprobada</span> Nos Respaldan
        </h2>
    </div>
</div>

<!-- Título del Servicio -->
<div class="container-fluid p-0 pt-3">
    <div class="text-center py-5 bg-black" data-aos="fade-up">
        <h2 class="text-white mb-3">@Model.ser_nombre</h2>
        <div style="width:60px;height:4px;background:#D42025;margin:auto;border-radius:2px;"></div>
    </div>
</div>

<!-- Detalle del Servicio -->
<div class="container-fluid mt-4 px-4">
    <div class="row my-5 align-items-center">
        <div class="col-md-6 text-center position-relative" data-aos="fade-right">
            <div class="image-container position-relative overflow-hidden rounded-3 shadow" style="max-height: 350px;">
                <img src="@Model.ser_imagen" alt="Imagen Servicio" class="img-fluid w-100 service-image"
                    style="height: 100%; object-fit: contain; transition: transform 0.5s ease;" />
                <div class="position-absolute top-0 start-0 m-3 d-flex flex-column align-items-start">
                    <span class="badge bg-light text-dark p-2"><i class="fas fa-clock me-1"></i> 60-90 min</span>
                </div>
            </div>
        </div>
        <div class="col-md-6" data-aos="fade-left">
            <h5 class="fw-bold">@Model.ser_nombre</h5>
            <p class="text-muted">@Model.ser_descripcion</p>
        </div>
    </div>

    <hr />

    <!-- Formulario de Reserva -->
    <div class="row my-5 align-items-center">
        <div class="col-lg-6 text-center mb-4" data-aos="zoom-in">
            <img src="https://www.foxwelldiag.com/cdn/shop/articles/10_debbfc55-4bf4-4238-8372-35cad9cc6181.jpg?v=1718870602&width=2048"
                alt="Reserva tu Servicio" class="img-fluid rounded shadow" />
        </div>

        <div class="col-lg-6" data-aos="fade-up">
            <div class="formulario-overlay" id="formularioOverlay" style="position: relative;">
                <div class="formulario-bloqueo" id="formularioBloqueo"
                    style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1050;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center bg-white p-4 rounded shadow">
                            <h5 class="text-danger mb-3">Inicia Sesión para Reservar</h5>
                            <a href="/Identity/Account/Login" class="btn btn-danger">Iniciar Sesión</a>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-4 shadow-lg bg-white">
                    <h4 class="text-center mb-4 text-danger">Reserva tu Servicio</h4>

                    <form asp-action="Reservar" asp-controller="Servicios" method="post" class="row g-3"
                        id="formulario">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ser_id" value="@Model.ser_id" />

                        <div class="col-12 col-md-6">
                            <label for="nombre" class="form-label">Nombre*</label>
                            <input type="text" class="form-control" id="nombre" value="@ViewBag.Nombre" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="apellido" class="form-label">Apellido*</label>
                            <input type="text" class="form-control" id="apellido" value="@ViewBag.Apellido" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="placa" class="form-label">Placa*</label>
                            <input type="text" class="form-control" id="placa" name="placa" required
                                placeholder="ABC123">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="telefono" class="form-label">Teléfono*</label>
                            <input type="hidden" id="telefono_internacional" name="telefono_internacional">
                            <input type="tel" class="form-control w-100" id="telefono" name="telefono" required
                                minlength="9" placeholder="9XXXXXXXX">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="fecha" class="form-label">Fecha*</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="hora" class="form-label">Hora*</label>
                            <select class="form-control" id="hora" name="hora" required>
                                <option value="">Selecciona una hora</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="detalle" class="form-label">Detalles adicionales</label>
                            <textarea class="form-control" id="detalle" name="detalle" rows="3"
                                placeholder="Añadir informacion relevante que ayude al diagnostico"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="row g-2">
                                <div class="col-md-6 mb-2">
                                    @if (ViewBag.TodasLasReservas != null && ViewBag.TodasLasReservas.Count > 0)
                                    {
                                        <div class="dropdown w-100">
                                            <button
                                                class="btn btn-outline-danger btn-lg dropdown-toggle btn-ver-reservas w-100 py-3"
                                                type="button" id="dropdownReservas" data-bs-toggle="dropdown"
                                                aria-expanded="false" disabled>
                                                <span>
                                                    <i class="far fa-calendar-alt me-2"></i>
                                                    Ver Posibles Cruces (@ViewBag.TodasLasReservas.Count)
                                                </span>
                                            </button>
                                            <div class="dropdown-menu w-100 p-0 border-0 shadow-sm">
                                                <div class="list-group" style="max-height: 225px; overflow-y: auto;">
                                                    @foreach (var reserva in
                                                                                                    ((IEnumerable<dynamic>)ViewBag.TodasLasReservas).OrderBy(r =>
                                                                                                    r.res_fecha).ThenBy(r => r.res_hora))
                                                    {
                                                        <div class="list-group-item border-0 py-2"
                                                            data-fecha="@reserva.res_fecha.ToString("yyyy-MM-dd")">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <i class="far fa-clock me-2 text-muted"></i>
                                                                    <span>@reserva.res_fecha.ToString("dd/MM/yyyy")</span>
                                                                    <span
                                                                        class="ms-2 badge bg-secondary">@reserva.ser_nombre</span>
                                                                </div>
                                                                <span class="badge bg-light text-dark">
                                                                    @reserva.res_hora.ToString(@"hh\:mm")
                                                                </span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-secondary btn-lg w-100 py-2 disabled">
                                            <i class="far fa-calendar-alt me-2"></i>No hay reservas
                                        </button>
                                    }
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="submit" class="btn btn-danger btn-lg w-100 py-3"
                                        style="background:#D42025;border:none;">
                                        <i class="fa fa-calendar-check-o me-2"></i>Reservar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección de Reseñas -->
<div class="container-fluid mt-5 px-4">
    <div class="row my-4">
        <div class="col-12 text-center" data-aos="fade-up">
            <h2 class="fw-bold mb-2" style="color: #000000; letter-spacing: 1px; text-transform: uppercase;">
                Reseña de Clientes
            </h2>
            <div style="width: 80px; height: 5px; background: #E42229; margin: 0 auto 10px auto; border-radius: 3px;">
            </div>
            <p class="text-muted mb-0" style="color: #626C66; font-size: 1rem;">
                Tu opinión sobre esta autoparte nos ayuda a mejorar
            </p>
        </div>

        <!-- Contenedor principal con efecto de sombra y bordes redondeados -->
        <div class="row g-4">
            <!-- Columna izquierda para formulario -->
            <div class="col-md-6 mb-5">
                <div class="bg-white rounded-4 shadow-lg p-5"
                    style="border-top: 5px solid #E42229; position: relative; overflow: hidden;">
                    <div
                        style="position: absolute; top: 0; right: 0; width: 120px; height: 120px; background: rgba(228, 34, 41, 0.1); border-radius: 0 0 0 120px;">
                    </div>

                    <h4 class="mb-4" style="color: #000000; font-weight: 700;">Compartenos tu Experiencia</h4>
                    <p class="mb-4" style="color: #626C66;">Se el primero en valorar "<span
                            style="color: #D42025; font-weight: 600;">@Model.ser_nombre</span>"</p>

                    <form id="formularioResenia" method="post" asp-action="AgregarResenia" asp-controller="Servicios"
                        class="row" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ser_id" value="@Model.ser_id" />
                        <input type="hidden" name="usuario_id" value="@ViewBag.UsuarioId" />

                        <div class="col-12 mb-3">
                            <label class="form-label" style="font-weight: 600; color: #000000;">Nombre:</label>
                            <input type="text" class="form-control" id="nombreUsuario" value="@ViewBag.Nombre" readonly
                                style="border-radius: 8px; border: 1px solid #e0e0e0; padding: 12px; background-color: #f9f9f9;" />
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label" style="font-weight: 600; color: #000000;">Correo
                                Electrónico:</label>
                            <input type="email" class="form-control" id="emailUsuario" value="@ViewBag.Correo" readonly
                                style="border-radius: 8px; border: 1px solid #e0e0e0; padding: 12px; background-color: #f9f9f9;" />
                        </div>

                        <div class="col-12 mb-4">
                            <label class="form-label" style="font-weight: 600; color: #000000;">Tu Puntuación:</label>
                            <div class="d-flex">
                                <input type="hidden" name="res_puntuacion" id="valoracionInput" value="0" required>
                                <div class="stars d-flex">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <span class="star" data-value="@i"
                                            style="font-size: 2.2rem; margin-right: 10px; cursor: pointer; color: #dddddd; transition: color 0.3s ease;">
                                            <i class="far fa-star"></i>
                                        </span>
                                    }
                                </div>
                                <div class="invalid-feedback" id="valoracionError" style="display: none;">
                                    Por favor, selecciona una valoración.
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mb-4">
                            <label class="form-label" style="font-weight: 600; color: #000000;">¿Te Gustó este
                                Servicio?</label>
                            <div class="d-flex gap-4 mt-2">
                                <div class="form-check form-check-inline custom-radio">
                                    <input class="form-check-input" type="radio" name="res_gusto" id="gustoSi"
                                        value="Si" checked
                                        style="width: 20px; height: 20px; border: 2px solid #E42229;">
                                    <label class="form-check-label ms-2" for="gustoSi" style="font-size: 1rem;">
                                        <i class="fas fa-thumbs-up me-1" style="color: #E42229;"></i> Sí me gustó
                                    </label>
                                </div>
                                <div class="form-check form-check-inline custom-radio">
                                    <input class="form-check-input" type="radio" name="res_gusto" id="gustoNo"
                                        value="No" style="width: 20px; height: 20px; border: 2px solid #626C66;">
                                    <label class="form-check-label ms-2" for="gustoNo" style="font-size: 1rem;">
                                        <i class="fas fa-thumbs-down me-1" style="color: #626C66;"></i> No me gustó
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mb-4">
                            <label for="res_comentario" class="form-label" style="font-weight: 600; color: #000000;">Tu
                                Comentario</label>
                            <textarea class="form-control" id="res_comentario" name="res_comentario" rows="4" required
                                placeholder="Comparte tu experiencia con este servicio..."
                                style="border-radius: 12px; border: 1px solid #e0e0e0; padding: 15px; resize: none;"></textarea>
                            <div class="invalid-feedback">
                                Por favor, escribe un comentario para continuar.
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-lg w-100 py-3" id="submitResenia"
                                style="background-color: #E42229; border: none; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; color: #FFFFFF;">
                                <i class="fas fa-paper-plane me-2"></i> Enviar Reseña
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Columna derecha para comentarios existentes -->
            <div class="col-md-6">
                <div class="bg-white rounded-4 shadow-lg p-5"
                    style="border-top: 5px solid #626C66; position: relative;">
                    <div
                        style="position: absolute; top: 0; right: 0; width: 120px; height: 120px; background: rgba(98, 108, 102, 0.1); border-radius: 0 0 0 120px;">
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 style="color: #000000; font-weight: 700;">Opiniones de Clientes</h4>
                        <span class="badge rounded-pill"
                            style="background-color: #626C66; padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-comments me-1"></i>
                            @if (ViewBag.Resenias != null)
                            {
                                <span>@(((IEnumerable<dynamic>)ViewBag.Resenias).Count()) reseñas</span>
                            }
                            else
                            {
                                <span>0 reseñas</span>
                            }
                        </span>
                    </div>

                    <div id="reseniasList" class="resenias-list"
                        style="max-height: 550px; overflow-y: auto; scrollbar-width: thin; padding-right: 10px;">
                        @if (ViewBag.Resenias != null && ((IEnumerable<dynamic>)ViewBag.Resenias).Any())
                        {
                            foreach (var resenia in (IEnumerable<dynamic>)ViewBag.Resenias)
                            {
                                <div class="resenia-item mb-4 p-4 border-bottom" id="resenia-@resenia.res_id"
                                    style="border-radius: 12px; background-color: #f9f9f9; border: none !important; transition: transform 0.2s ease-in-out;">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 50px; height: 50px; background: linear-gradient(135deg, #E42229, #D42025); color: white;">
                                                <i class="fas fa-user-circle fa-2x"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-bold" style="color: #000000; font-size: 1.1rem;">
                                                @resenia.usuario_nombre</h6>
                                            <div class="d-flex align-items-center">
                                                <div class="rating-stars me-2">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        <i class="@(i <= resenia.res_puntuacion ? "fas" : "far") fa-star"
                                                            style="color: @(i <= resenia.res_puntuacion ? "#E42229" : "#dddddd");"></i>
                                                    }
                                        </div>
                                        <small style="color: #626C66;">@((resenia.res_fecha as
                                                                                        DateTime?).Value.ToString("dd/MM/yyyy"))</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 ps-2" style="border-left: 3px solid #E42229; padding-left: 15px;">
                                <p class="mb-3" style="color: #000000; line-height: 1.6;">@resenia.res_comentario</p>
                                <span class="badge" style="background-color: @(resenia.res_gusto == "Si" ? "#E42229" : "#626C66"); 
                                                   padding: 6px 12px; font-size: 0.85rem; border-radius: 30px;">
                                    @if (resenia.res_gusto == "Si")
                                            {
                                                <i class="fas fa-thumbs-up me-1"></i>
                                                <span>Me gustó</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-thumbs-down me-1"></i>
                                                <span>No me gustó</span>
                                            }
                                        </span>
                                    </div>
                                    @if (resenia.usuario_id == ViewBag.UsuarioId)
                                    {
                                        <div class="text-end">
                                            <button class="btn btn-sm eliminar-resenia" data-id="@resenia.res_id"
                                                data-bs-toggle="modal" data-bs-target="#confirmarEliminarModal"
                                                style="background-color: transparent; color: #626C66; border: 1px solid #626C66; border-radius: 30px; padding: 5px 15px; transition: all 0.3s ease;">
                                                <i class="fas fa-trash-alt me-1"></i> Eliminar
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5" id="noComments"
                                style="background-color: #f9f9f9; border-radius: 12px; padding: 40px 20px;">
                                <i class="far fa-comment-dots fa-4x mb-3" style="color: #E42229;"></i>
                                <h5 style="color: #000000; font-weight: 600;">No hay comentarios todavía</h5>
                                <p class="text-muted mt-2" style="color: #626C66;">¡Sé el primero en compartir tu
                                    experiencia!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmación para Eliminar Reseña -->
        <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none;">
                    <div class="modal-header" style="background-color: #E42229; color: #FFFFFF; border: none;">
                        <h5 class="modal-title" id="confirmarEliminarModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Confirmar Eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-trash-alt fa-3x" style="color: #E42229;"></i>
                        </div>
                        <h5 style="color: #000000;">¿Estás seguro de que deseas eliminar este comentario?</h5>
                        <p class="text-muted mt-2" style="color: #626C66;">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer" style="border: none; padding: 0 20px 20px;">
                        <form asp-action="EliminarResenia" asp-controller="Servicios" method="post"
                            class="d-flex gap-2 w-100">
                            <input type="hidden" id="reseniaIdEliminar" name="res_id" value="" />
                            <input type="hidden" name="ser_id" value="@Model.ser_id" />
                            <button type="button" class="btn flex-grow-1" data-bs-dismiss="modal"
                                style="border-radius: 10px; background-color: #f0f0f0; color: #626C66; font-weight: 600; padding: 10px;">
                                Cancelar
                            </button>
                            <button type="submit" class="btn flex-grow-1"
                                style="border-radius: 10px; background-color: #E42229; color: #FFFFFF; font-weight: 600; padding: 10px;">
                                <i class="fas fa-trash-alt me-2"></i> Eliminar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Éxito para Reseña Registrada -->
        <div class="modal fade" id="reseniaExitoModal" tabindex="-1" aria-labelledby="reseniaExitoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none;">
                    <div class="modal-header" style="background-color: #E42229; color: #FFFFFF; border: none;">
                        <h5 class="modal-title" id="reseniaExitoModalLabel">
                            <i class="fas fa-check-circle me-2"></i>
                            ¡Reseña registrada!
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-thumbs-up fa-3x" style="color: #E42229;"></i>
                        </div>
                        <h5 style="color: #000000;">¡Tu reseña ha sido publicada correctamente!</h5>
                        <p class="text-muted mt-2" style="color: #626C66;">Gracias por compartir tu experiencia con
                            nosotros.</p>
                        <button type="button" class="btn mt-3" data-bs-dismiss="modal"
                            style="background-color: #E42229; color: #FFFFFF; font-weight: 600; padding: 10px 20px; border-radius: 10px;">
                            <i class="fas fa-times me-2"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Éxito para Reseña Eliminada -->
        <div class="modal fade" id="reseniaEliminadaModal" tabindex="-1" aria-labelledby="reseniaEliminadaModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none;">
                    <div class="modal-header" style="background-color: #626C66; color: #FFFFFF; border: none;">
                        <h5 class="modal-title" id="reseniaEliminadaModalLabel">
                            <i class="fas fa-trash-alt me-2"></i>
                            Comentario eliminado
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-check-circle fa-3x" style="color: #626C66;"></i>
                        </div>
                        <h5 style="color: #000000;">Tu comentario ha sido eliminado correctamente.</h5>
                        <button type="button" class="btn mt-3" data-bs-dismiss="modal"
                            style="background-color: #626C66; color: #FFFFFF; font-weight: 600; padding: 10px 20px; border-radius: 10px;">
                            <i class="fas fa-times me-2"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Animación para elementos al cargar la página
        const reseniaItems = document.querySelectorAll('.resenia-item');
        reseniaItems.forEach((item, index) => {
            setTimeout(() => {
                item.style.opacity = '1';
            }, 100 * index);
        });

        // Sistema de valoración por estrellas
        const stars = document.querySelectorAll('.star');
        const valoracionInput = document.getElementById('valoracionInput');

        stars.forEach(star => {
            // Evento hover
            star.addEventListener('mouseover', () => {
                const value = star.getAttribute('data-value');
                highlightStars(value);
            });

            // Evento click
            star.addEventListener('click', () => {
                const value = star.getAttribute('data-value');
                valoracionInput.value = value;
                highlightStars(value, true);
            });
        });

        // Resetear estrellas cuando el mouse sale del contenedor
        const starsContainer = document.querySelector('.stars');
        starsContainer.addEventListener('mouseleave', () => {
            const selectedValue = valoracionInput.value;
            highlightStars(selectedValue, true);
        });

        // Función para iluminar las estrellas
        function highlightStars(count, permanent = false) {
            stars.forEach(star => {
                const starValue = star.getAttribute('data-value');
                const icon = star.querySelector('i');

                if (starValue <= count) {
                    icon.className = 'fas fa-star';
                    star.style.color = '#E42229';
                } else {
                    if (!permanent || valoracionInput.value < starValue) {
                        icon.className = 'far fa-star';
                        star.style.color = '#dddddd';
                    }
                }
            });
        }

        // Validación del formulario
        const formularioResenia = document.getElementById('formularioResenia');
        const comentarioInput = document.getElementById('res_comentario');
        const comentarioError = document.getElementById('comentarioError');
        const valoracionError = document.getElementById('valoracionError');

        formularioResenia.addEventListener('submit', function (event) {
            let valid = true;

            // Validar valoración
            if (valoracionInput.value == '0') {
                valoracionError.style.display = 'block';
                valid = false;
            } else {
                valoracionError.style.display = 'none';
            }

            // Validar comentario
            if (comentarioInput.value.trim() === '') {
                comentarioInput.classList.add('is-invalid');
                comentarioError.style.display = 'block';
                valid = false;
            } else {
                comentarioInput.classList.remove('is-invalid');
                comentarioError.style.display = 'none';
            }

            if (!valid) {
                event.preventDefault();
            }
        });

        // Modal para eliminación
        const eliminarButtons = document.querySelectorAll('.eliminar-resenia');
        const reseniaIdEliminar = document.getElementById('reseniaIdEliminar');

        eliminarButtons.forEach(button => {
            button.addEventListener('click', function () {
                const reseniaId = this.getAttribute('data-id');
                reseniaIdEliminar.value = reseniaId;
            });
        });

        // Mostrar modal de éxito si viene del controlador
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');

        if (status === 'success') {
            const reseniaExitoModal = new bootstrap.Modal(document.getElementById('reseniaExitoModal'));
            reseniaExitoModal.show();
        } else if (status === 'deleted') {
            const reseniaEliminadaModal = new bootstrap.Modal(document.getElementById('reseniaEliminadaModal'));
            reseniaEliminadaModal.show();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const stars = document.querySelectorAll('.star');
        const valoracionInput = document.getElementById('valoracionInput');
        const valoracionError = document.getElementById('valoracionError');
        const formularioResenia = document.getElementById('formularioResenia');
        const comentario = document.getElementById('comentario');
        const comentarioError = document.getElementById('comentarioError');
        const botonesEliminar = document.querySelectorAll('.eliminar-resenia');
        const reseniaIdInput = document.getElementById('reseniaIdEliminar');

        botonesEliminar.forEach(boton => {
            boton.addEventListener('click', function () {
                const reseniaId = this.getAttribute('data-id');
                reseniaIdInput.value = reseniaId;
            });
        });

        // Función para actualizar las estrellas visualmente
        function updateStars(value) {
            stars.forEach((s, index) => {
                const icon = s.querySelector('i');
                if (index < value) {
                    s.classList.add('active');
                    icon.className = 'fas fa-star';
                } else {
                    s.classList.remove('active');
                    icon.className = 'far fa-star';
                }
            });
        }

        // Comportamiento al hacer clic en una estrella
        stars.forEach(star => {
            star.addEventListener('click', function () {
                const value = parseInt(this.getAttribute('data-value'));
                valoracionInput.value = value;
                updateStars(value);
                valoracionError.style.display = 'none';
            });

            star.addEventListener('mouseover', function () {
                const value = parseInt(this.getAttribute('data-value'));
                stars.forEach((s, index) => {
                    if (index < value) {
                        s.querySelector('i').className = 'fas fa-star';
                    }
                });
            });

            star.addEventListener('mouseout', function () {
                const currentValue = parseInt(valoracionInput.value);
                updateStars(currentValue);
            });
        });

        // Validación antes de enviar
        if (formularioResenia) {
            formularioResenia.addEventListener('submit', function (e) {
                let isValid = true;

                // Validar comentario
                if (!comentario.value.trim()) {
                    comentario.classList.add('is-invalid');
                    comentarioError.style.display = 'block';
                    isValid = false;
                } else {
                    comentario.classList.remove('is-invalid');
                    comentarioError.style.display = 'none';
                }

                // Validar puntuación
                if (valoracionInput.value == 0) {
                    valoracionError.style.display = 'block';
                    isValid = false;
                } else {
                    valoracionError.style.display = 'none';
                }

                // Si no es válido, evitamos que se envíe
                if (!isValid) {
                    e.preventDefault();
                }
            });
        }
    });

    AOS.init({ once: true });
    function mostrarModalLogin() {
        var modal = new bootstrap.Modal(document.getElementById('loginRequeridoModal'));
        modal.show();
    }
    document.addEventListener("DOMContentLoaded", function () {
        var usuarioAutenticado = @(usuarioAutenticado.ToString().ToLower());
        if (!usuarioAutenticado) {
            var bloqueo = document.getElementById('formularioBloqueo');
            bloqueo.style.display = 'block';
        }
    });
    document.getElementById('formulario').addEventListener('submit', function (e) {
        var iti = window.intlTelInputGlobals.getInstance(document.getElementById('telefono'));

        // Validar que el número sea válido
        if (!iti.isValidNumber()) {
            e.preventDefault();
            var errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
            document.getElementById('errorReservaMensaje').innerHTML = "El teléfono debe tener el formato internacional correcto.";
            errorModal.show();
            return false;
        }

        var numeroIntl = iti.getNumber();

        var countryCode = iti.getSelectedCountryData().dialCode;

        var numeroFormateado = numeroIntl.replace('+' + countryCode, '+' + countryCode + ' ');

        document.getElementById('telefono_internacional').value = numeroFormateado;
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Inicializa intl-tel-input
        var input = document.querySelector("#telefono");
        window.intlTelInput(input, {
            initialCountry: "pe",
            preferredCountries: ["pe", "ar", "es", "us", "br"],
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js"
        });
        // Referencias a elementos del formulario
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        const formulario = document.getElementById('formulario');

        // Guardar fecha y hora al seleccionarlas
        if (fechaInput) {
            fechaInput.addEventListener('change', function () {
                localStorage.setItem('reserva_fecha', this.value);
            });
        }

        if (horaInput) {
            horaInput.addEventListener('change', function () {
                localStorage.setItem('reserva_hora', this.value);
            });
        }

        // Guardar al enviar formulario
        if (formulario) {
            formulario.addEventListener('submit', function (e) {
                // Validación del teléfono
                const iti = window.intlTelInputGlobals.getInstance(document.getElementById('telefono'));
                if (!iti.isValidNumber()) {
                    e.preventDefault();
                    const errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
                    document.getElementById('errorReservaMensaje').innerHTML = "El teléfono debe tener el formato internacional correcto.";
                    errorModal.show();
                    return false;
                }

                // Formatear teléfono internacional
                const numeroIntl = iti.getNumber();
                const countryCode = iti.getSelectedCountryData().dialCode;
                const numeroFormateado = numeroIntl.replace('+' + countryCode, '+' + countryCode + ' ');
                document.getElementById('telefono_internacional').value = numeroFormateado;

                // Guardar fecha y hora en localStorage
                const fechaValue = document.getElementById('fecha').value;
                const horaValue = document.getElementById('hora').value;
                if (fechaValue && horaValue) {
                    localStorage.setItem('reserva_fecha', fechaValue);
                    localStorage.setItem('reserva_hora', horaValue);
                }
            });
        }
        // Inicializa mensaje de éxito
        const successMessage = document.querySelector(".success-message");
        if (successMessage) {
            setTimeout(() => {
                successMessage.classList.add("hide");
                setTimeout(() => successMessage.remove(), 500);
            }, 10000);
        }
        // Mostrar modal de error si existe
        var errorMsg = '@Html.Raw(TempData["ErrorReserva"])';
        if (errorMsg && errorMsg !== '') {
            var errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
            document.getElementById('errorReservaMensaje').innerHTML = errorMsg;
            errorModal.show();
            return;
        }
        // Inicializar Cruces
        const crucesBtn = document.getElementById('dropdownReservas');
        const listGroup = document.querySelector('.list-group');
        const allItems = Array.from(document.querySelectorAll('.list-group-item[data-fecha]'));

        function actualizarCruces() {
            if (!fechaInput || !crucesBtn) return;
            const selectedDate = fechaInput.value;
            let count = 0;
            allItems.forEach(item => {
                if (item.getAttribute('data-fecha') === selectedDate) {
                    item.style.display = '';
                    count++;
                } else {
                    item.style.display = 'none';
                }
            });
            // Actualiza el contador y el estado del botón
            const countSpan = crucesBtn.querySelector('span');
            if (count > 0) {
                crucesBtn.disabled = false;
                if (countSpan) {
                    countSpan.innerHTML = `<i class="far fa-calendar-alt me-2"></i>Ver Posibles Cruces (${count})`;
                }
            } else {
                crucesBtn.disabled = true;
                if (countSpan) {
                    countSpan.innerHTML = `<i class="far fa-calendar-alt me-2"></i>No hay cruces`;
                }
            }
        }
        if (fechaInput && crucesBtn) {
            fechaInput.addEventListener('input', actualizarCruces);
            actualizarCruces();
        }

        // Mostrar modal de calendario si la reserva fue exitosa
        const reservaExitosa = '@TempData["ReservaExitosa"]';
        if (reservaExitosa && reservaExitosa !== '') {
            const calendarioModal = new bootstrap.Modal(document.getElementById('calendarioModal'));
            calendarioModal.show();

            // Obtener datos guardados en localStorage
            const fechaGuardada = localStorage.getItem('reserva_fecha');
            const horaGuardada = localStorage.getItem('reserva_hora');

            // Datos para el evento
            const nombreServicio = '@Html.Raw(Json.Serialize(Model.ser_nombre))'.replace(/"/g, '');
            const titulo = `Reserva Marimon - ${nombreServicio}`;
            const descripcion = `Servicio: ${nombreServicio}`;
            const location = 'Jr. Gral. Felipe Santiago Salaverry 44, Lima 15022, Perú';

            // Crear fecha con los valores guardados
            const fechaHora = new Date();

            if (fechaGuardada) {
                const [year, month, day] = fechaGuardada.split('-');
                fechaHora.setFullYear(parseInt(year), parseInt(month) - 1, parseInt(day));
            }

            if (horaGuardada) {
                const [hours, minutes] = horaGuardada.split(':');
                fechaHora.setHours(parseInt(hours), parseInt(minutes), 0);
            }

            // Formato para Google Calendar
            const fechaInicio = fechaHora.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const fechaFin = new Date(fechaHora.getTime() + 60 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const googleUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titulo)}&dates=${fechaInicio}/${fechaFin}&details=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(location)}`;
            document.getElementById('googleCalendarLink').href = googleUrl;

            // Formato para Outlook Calendar 
            const fechaInicioOutlook = fechaHora.toISOString().replace('.000', '');
            const fechaFinOutlook = new Date(fechaHora.getTime() + 60 * 60 * 1000).toISOString().replace('.000', '');
            const outlookUrl = `https://outlook.office.com/calendar/action/compose?subject=${encodeURIComponent(titulo)}&startdt=${fechaInicioOutlook}&enddt=${fechaFinOutlook}&body=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(location)}`;
            document.getElementById('outlookCalendarLink').href = outlookUrl;
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>