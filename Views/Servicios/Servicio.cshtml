@model Marimon.Models.Servicio
@{
    ViewBag.Title = "Servicios";
    ViewBag.FullWidthLayout = true;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var usuarioAutenticado = ViewBag.UsuarioAutenticado as bool? ?? false;
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/css/intlTelInput.min.css" />
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/intlTelInput.min.js"></script>
<link rel="stylesheet" href="~/css/home.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
    .container {
        padding: 0;
        margin: 0;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
</style>

@if (TempData["ReservaExitosa"] != null)
{
    <div class="alert alert-success success-message position-fixed" role="alert">
        <strong>Éxito</strong>: ¡Reserva realizada con éxito!
        <button type="button" class="btn-close" aria-label="Close" onclick="this.parentElement.remove();"></button>
    </div>
}

<div class="modal fade" id="errorReservaModal" tabindex="-1" aria-labelledby="errorReservaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorReservaModalLabel">Error en la Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <span id="errorReservaMensaje"></span>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Calendario -->
<div class="modal fade" id="calendarioModal" tabindex="-1" aria-labelledby="calendarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarioModalLabel">¡Reserva exitosa!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p>¿Deseas agregar tu cita a tu calendario?</p>
                <a id="googleCalendarLink" href="#" target="_blank" class="btn btn-success mb-2 w-100">Agregar a Google
                    Calendar</a>
                <a id="outlookCalendarLink" href="#" target="_blank" class="btn btn-primary w-100">Agregar a Outlook
                    Calendar</a>
            </div>
        </div>
    </div>
</div>

<!-- Banner -->
<div class="container-fluid p-0 position-relative" style="height: 350px; overflow: hidden;">
    <img src="https://firebasestorage.googleapis.com/v0/b/marimonapp.appspot.com/o/Assest_web%2Fimg-galeria-01.jpg?alt=media&token=8119fed0-1123-40cb-81b1-a2d9ce3e4b81"
        alt="Banner" class="img-fluid w-100 h-100" style="object-fit: cover; filter: brightness(0.6);" />
    <div class="banner-overlay position-absolute top-0 start-0 w-100 h-100"
        style="background: linear-gradient(180deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.8) 100%);">
    </div>
    <div class="banner-text position-absolute top-50 start-50 translate-middle text-center text-white"
        data-aos="fade-down">
        <h4 class="text-uppercase fw-bold fs-7 mb-2" style="letter-spacing:2px;">
            EXPERTOS EN TU VEHÍCULO
        </h4>
        <h2 class="fw-bold fs-2">
            ¡Tu Tranquilidad Es Nuestra Prioridad!<br>
            <span style="color:#ff9d00;">Años de Experiencia Comprobada</span> Nos Respaldan
        </h2>
    </div>
</div>

<!-- Título del Servicio -->
<div class="container-fluid p-0 pt-3">
    <div class="text-center py-5 bg-black" data-aos="fade-up">
        <h2 class="text-white mb-3">@Model.ser_nombre</h2>
        <div style="width:60px;height:4px;background:#D42025;margin:auto;border-radius:2px;"></div>
    </div>
</div>

<!-- Detalle del Servicio -->
<div class="container-fluid mt-4 px-4">
    <div class="row my-5 align-items-center">
        <div class="col-md-6 text-center position-relative" data-aos="fade-right">
            <div class="image-container position-relative overflow-hidden rounded-3 shadow" style="max-height: 350px;">
                <img src="@Model.ser_imagen" alt="Imagen Servicio" class="img-fluid w-100 service-image"
                    style="height: 100%; object-fit: contain; transition: transform 0.5s ease;" />
                <div class="position-absolute top-0 start-0 m-3 d-flex flex-column align-items-start">
                    <span class="badge bg-light text-dark p-2"><i class="fas fa-clock me-1"></i> 60-90 min</span>
                </div>
            </div>
        </div>
        <div class="col-md-6" data-aos="fade-left">
            <h5 class="fw-bold">@Model.ser_nombre</h5>
            <p class="text-muted">@Model.ser_descripcion</p>
        </div>
    </div>

    <hr />

    <!-- Formulario de Reserva -->
    <div class="row my-5 align-items-center">
        <div class="col-lg-6 text-center mb-4" data-aos="zoom-in">
            <img src="https://www.foxwelldiag.com/cdn/shop/articles/10_debbfc55-4bf4-4238-8372-35cad9cc6181.jpg?v=1718870602&width=2048"
                alt="Reserva tu Servicio" class="img-fluid rounded shadow" />
        </div>

        <div class="col-lg-6" data-aos="fade-up">
            <div class="formulario-overlay" id="formularioOverlay" style="position: relative;">
                <div class="formulario-bloqueo" id="formularioBloqueo"
                    style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1050;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center bg-white p-4 rounded shadow">
                            <h5 class="text-danger mb-3">Inicia sesión para reservar</h5>
                            <a href="/Identity/Account/Login" class="btn btn-danger">Iniciar sesión</a>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-4 shadow-lg bg-white">
                    <h4 class="text-center mb-4 text-danger">Reserva tu Servicio</h4>

                    <form asp-action="Reservar" asp-controller="Servicios" method="post" class="row g-3"
                        id="formulario">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ser_id" value="@Model.ser_id" />

                        <div class="col-12 col-md-6">
                            <label for="nombre" class="form-label">Nombre*</label>
                            <input type="text" class="form-control" id="nombre" value="@ViewBag.Nombre" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="apellido" class="form-label">Apellido*</label>
                            <input type="text" class="form-control" id="apellido" value="@ViewBag.Apellido" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="placa" class="form-label">Placa*</label>
                            <input type="text" class="form-control" id="placa" name="placa" required
                                placeholder="ABC123">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="telefono" class="form-label">Teléfono*</label>
                            <input type="hidden" id="telefono_internacional" name="telefono_internacional">
                            <input type="tel" class="form-control w-100" id="telefono" name="telefono" required
                                minlength="9" placeholder="9XXXXXXXX">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="fecha" class="form-label">Fecha*</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="hora" class="form-label">Hora*</label>
                            <select class="form-control" id="hora" name="hora" required>
                                <option value="">Selecciona una hora</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="detalle" class="form-label">Detalles adicionales</label>
                            <textarea class="form-control" id="detalle" name="detalle" rows="3"
                                placeholder="Añadir informacion relevante que ayude al diagnostico"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="row g-2">
                                <div class="col-md-6 mb-2">
                                    @if (ViewBag.TodasLasReservas != null && ViewBag.TodasLasReservas.Count > 0)
                                    {
                                        <div class="dropdown w-100">
                                            <button
                                                class="btn btn-outline-danger btn-lg dropdown-toggle btn-ver-reservas w-100 py-3"
                                                type="button" id="dropdownReservas" data-bs-toggle="dropdown"
                                                aria-expanded="false" disabled>
                                                <span>
                                                    <i class="far fa-calendar-alt me-2"></i>
                                                    Ver Posibles Cruces (@ViewBag.TodasLasReservas.Count)
                                                </span>
                                            </button>
                                            <div class="dropdown-menu w-100 p-0 border-0 shadow-sm">
                                                <div class="list-group" style="max-height: 225px; overflow-y: auto;">
                                                    @foreach (var reserva in
                                                                                                    ((IEnumerable<dynamic>)ViewBag.TodasLasReservas).OrderBy(r =>
                                                                                                    r.res_fecha).ThenBy(r => r.res_hora))
                                                    {
                                                        <div class="list-group-item border-0 py-2"
                                                            data-fecha="@reserva.res_fecha.ToString("yyyy-MM-dd")">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <i class="far fa-clock me-2 text-muted"></i>
                                                                    <span>@reserva.res_fecha.ToString("dd/MM/yyyy")</span>
                                                                    <span
                                                                        class="ms-2 badge bg-secondary">@reserva.ser_nombre</span>
                                                                </div>
                                                                <span class="badge bg-light text-dark">
                                                                    @reserva.res_hora.ToString(@"hh\:mm")
                                                                </span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-secondary btn-lg w-100 py-2 disabled">
                                            <i class="far fa-calendar-alt me-2"></i>No hay reservas
                                        </button>
                                    }
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="submit" class="btn btn-danger btn-lg w-100 py-3"
                                        style="background:#D42025;border:none;">
                                        <i class="fa fa-calendar-check-o me-2"></i>Reservar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección de Reseñas -->
<div class="container-fluid mt-5 px-4">
    <div class="row my-5">
        <div class="col-12 text-center mb-4" data-aos="fade-up">
            <h3 class="fw-bold">Reseñas</h3>
            <div style="width:60px;height:4px;background:#D42025;margin:auto;border-radius:2px;"></div>
        </div>

        <!-- Contenedor principal dividido en dos columnas lado a lado -->
        <div class="row">
            <!-- Columna izquierda para formulario -->
            <div class="col-md-6 mb-5">
                <div class="bg-white rounded-4 shadow-lg p-4">
                    <h5 class="mb-4">Se el Primero en Valorar "@Model.ser_nombre"</h5>

                    <form id="formularioResenia" class="row">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ser_id" value="@Model.ser_id" />
                        <input type="hidden" name="usuario_id" value="@ViewBag.UsuarioId" />

                        <div class="col-12 mb-3">
                            <label class="form-label">Nombre:</label>
                            <input type="text" class="form-control" id="nombreUsuario"
                                value="@ViewBag.Nombre" readonly />
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label">Correo Electrónico:</label>
                            <input type="email" class="form-control" id="emailUsuario" value="@ViewBag.Correo"
                                readonly />
                        </div>

                        <div class="col-12 mb-4">
                            <label class="form-label">Tu Puntuación:</label>
                            <div class="d-flex">
                                <input type="hidden" name="valoracion" id="valoracionInput" value="0" required>
                                <div class="stars d-flex">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <span class="star" data-value="@i"
                                            style="font-size: 2rem; margin-right: 10px; cursor: pointer; color: #dddddd; transition: color 0.2s ease;">
                                            <i class="far fa-star"></i>
                                        </span>
                                    }
                                </div>
                                <div class="invalid-feedback" id="valoracionError" style="display: none;">
                                    Por favor, selecciona una valoración.
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label">¿Te Gustó este servicio?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gusto" id="gustoSi" value="Si"
                                    checked>
                                <label class="form-check-label" for="gustoSi">Si</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gusto" id="gustoNo" value="No">
                                <label class="form-check-label" for="gustoNo">No</label>
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="comentario" class="form-label">Tu Comentario</label>
                            <textarea class="form-control" id="comentario" name="comentario" rows="4" required
                                placeholder="Escribe tu comentario aquí..."></textarea>
                            <div class="invalid-feedback" id="comentarioError">
                                Por favor, escribe un comentario para continuar.
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary" id="submitResenia"
                                style="background-color: #2E4BDB; border: none;">
                                Enviar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Columna derecha para comentarios existentes -->
            <div class="col-md-6">
                <div class="bg-white rounded-4 shadow-lg p-4">
                    <h5 class="mb-4">Comentarios</h5>

                    <div id="reseniasList" class="resenias-list" style="max-height: 500px; overflow-y: auto;">
                        @if (ViewBag.Resenias != null && ViewBag.Resenias.Count > 0)
                        {
                            foreach (var resenia in ViewBag.Resenias)
                            {
                                <div class="resenia-item mb-4 pb-3 border-bottom" id="resenia-@resenia.res_id">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="me-3">
                                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" 
                                                style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-secondary"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-bold">@resenia.usuario_nombre</h6>
                                            <div class="d-flex align-items-center">
                                                <!-- Mostrar estrellas según valoración -->
                                                <div class="rating-stars me-2">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        <i class="@(i <= resenia.valoracion ? "fas" : "far") fa-star text-warning"></i>
                                                    }
                                                </div>
                                                <small class="text-muted">@resenia.res_fecha.ToString("dd/MM/yyyy")</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <p class="mb-1">@resenia.res_comentario</p>
                                        <span class="badge @(resenia.gusto == "Si" ? "bg-success" : "bg-danger")">
                                            @(resenia.gusto == "Si" ? "Me gustó" : "No me gustó")
                                        </span>
                                    </div>

                                    @if (resenia.usuario_id == ViewBag.UsuarioId)
                                    {
                                        <div class="text-end">
                                            <button class="btn btn-sm btn-outline-danger eliminar-resenia"
                                                data-id="@resenia.res_id" data-bs-toggle="modal"
                                                data-bs-target="#confirmarEliminarModal">
                                                <i class="fas fa-trash-alt"></i> Eliminar
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5" id="noComments">
                                <p class="mb-0">No hay comentarios para este servicio.</p>
                                <p class="text-muted">¡Sé el primero en comentar!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Reseña -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmarEliminarModalLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p>¿Estás seguro de que deseas eliminar este comentario?</p>
                <p class="text-muted">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form asp-action="EliminarResenia" asp-controller="Servicios" method="post" id="eliminarReseniaForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="res_id" id="reseniaIdEliminar" value="">
                    <input type="hidden" name="ser_id" value="@Model.ser_id">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Éxito para Reseña Registrada -->
<div class="modal fade" id="reseniaExitoModal" tabindex="-1" aria-labelledby="reseniaExitoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="reseniaExitoModalLabel">¡Reseña registrada!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p>Tu reseña ha sido publicada correctamente.</p>
                <p class="text-muted">Gracias por compartir tu experiencia.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Éxito para Reseña Eliminada -->
<div class="modal fade" id="reseniaEliminadaModal" tabindex="-1" aria-labelledby="reseniaEliminadaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="reseniaEliminadaModalLabel">Comentario eliminado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p>Tu comentario ha sido eliminado correctamente.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Funcionalidad para las estrellas en el formulario
    const stars = document.querySelectorAll('.star');
    const valoracionInput = document.getElementById('valoracionInput');
    const valoracionError = document.getElementById('valoracionError');

    // Función para actualizar las estrellas
    function updateStars(value) {
        stars.forEach((s, index) => {
            if (index < value) {
                s.classList.add('active');
                s.querySelector('i').className = 'fas fa-star';
            } else {
                s.classList.remove('active');
                s.querySelector('i').className = 'far fa-star';
            }
        });
    }

    stars.forEach(star => {
        star.addEventListener('click', function () {
            const value = parseInt(this.getAttribute('data-value'));
            valoracionInput.value = value;
            updateStars(value);
            valoracionError.style.display = 'none';
        });

        // Efectos hover
        star.addEventListener('mouseover', function () {
            const value = parseInt(this.getAttribute('data-value'));
            
            stars.forEach((s, index) => {
                if (index < value) {
                    s.querySelector('i').className = 'fas fa-star';
                }
            });
        });

        star.addEventListener('mouseout', function () {
            const currentValue = parseInt(valoracionInput.value);
            updateStars(currentValue);
        });
    });

    // Validación del formulario de reseña y agregado directo del comentario
    const formularioResenia = document.getElementById('formularioResenia');
    const comentario = document.getElementById('comentario');
    const comentarioError = document.getElementById('comentarioError');
    const reseniasList = document.getElementById('reseniasList');
    const noComments = document.getElementById('noComments');

    if (formularioResenia) {
        formularioResenia.addEventListener('submit', function (e) {
            e.preventDefault();
            let isValid = true;

            // Validar comentario
            if (!comentario.value.trim()) {
                comentario.classList.add('is-invalid');
                comentarioError.style.display = 'block';
                isValid = false;
            } else {
                comentario.classList.remove('is-invalid');
                comentarioError.style.display = 'none';
            }

            // Validar valoración
            if (valoracionInput.value == 0) {
                valoracionError.style.display = 'block';
                isValid = false;
            } else {
                valoracionError.style.display = 'none';
            }

            if (isValid) {
                // Crear objeto de reseña con los datos del formulario
                const nuevaResenia = {
                    res_id: Date.now(), // ID temporal
                    valoracion: parseInt(valoracionInput.value),
                    comentario: comentario.value.trim(),
                    gusto: document.getElementById('gustoSi').checked ? 'Si' : 'No',
                    usuario_nombre: document.getElementById('nombreUsuario').value
                };
                
                // Mostrar inmediatamente la reseña en la columna de comentarios
                addNewReview(nuevaResenia);
                
                // También enviamos los datos al servidor en segundo plano
                const formData = new FormData(formularioResenia);
                
                fetch('/Servicios/AgregarResenia', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar el modal de éxito
                        const reseniaExitoModal = new bootstrap.Modal(document.getElementById('reseniaExitoModal'));
                        reseniaExitoModal.show();
                        
                        // Actualizar el ID de la reseña con el real del servidor si es necesario
                        if (data.resenia && data.resenia.res_id) {
                            const tempElement = document.getElementById(`resenia-${nuevaResenia.res_id}`);
                            if (tempElement) {
                                tempElement.id = `resenia-${data.resenia.res_id}`;
                                const eliminarBtn = tempElement.querySelector('.eliminar-resenia');
                                if (eliminarBtn) {
                                    eliminarBtn.setAttribute('data-id', data.resenia.res_id);
                                }
                            }
                        }
                    } else {
                        console.error('Error al guardar la reseña:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
                
                // Resetear el formulario después de mostrar la reseña
                resetForm();
            }
        });
    }

    // Función para agregar una nueva reseña al DOM
    function addNewReview(resenia) {
        // Si no hay comentarios, eliminar el mensaje de no hay comentarios
        if (noComments && noComments.parentNode) {
            noComments.remove();
        }

        // Crear el elemento de nueva reseña
        const newReseniaElement = document.createElement('div');
        newReseniaElement.className = 'resenia-item mb-4 pb-3 border-bottom fade-in highlight-new';
        newReseniaElement.id = `resenia-${resenia.res_id}`;
        
        // Obtener la fecha actual formateada
        const hoy = new Date();
        const fechaFormateada = hoy.toLocaleDateString('es-ES');
        
        // Crear estrellas HTML
        let estrellasHTML = '';
        for (let i = 1; i <= 5; i++) {
            estrellasHTML += `<i class="${i <= resenia.valoracion ? 'fas' : 'far'} fa-star text-warning"></i>`;
        }
        
        // Construir el HTML interno
        newReseniaElement.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <div class="me-3">
                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" 
                        style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-secondary"></i>
                    </div>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold">${document.getElementById('nombreUsuario').value}</h6>
                    <div class="d-flex align-items-center">
                        <div class="rating-stars me-2">
                            ${estrellasHTML}
                        </div>
                        <small class="text-muted">${fechaFormateada}</small>
                    </div>
                </div>
            </div>
            
            <div class="mb-2">
                <p class="mb-1">${resenia.comentario}</p>
                <span class="badge ${resenia.gusto === 'Si' ? 'bg-success' : 'bg-danger'}">
                    ${resenia.gusto === 'Si' ? 'Me gustó' : 'No me gustó'}
                </span>
            </div>

            <div class="text-end">
                <button class="btn btn-sm btn-outline-danger eliminar-resenia"
                    data-id="${resenia.res_id}" data-bs-toggle="modal"
                    data-bs-target="#confirmarEliminarModal">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>
        `;
        
        // Agregar la nueva reseña al principio de la lista
        reseniasList.insertBefore(newReseniaElement, reseniasList.firstChild);
        
        // Hacer scroll al nuevo comentario para asegurar que sea visible
        newReseniaElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Agregar el listener para el botón eliminar
        const nuevoBotonEliminar = newReseniaElement.querySelector('.eliminar-resenia');
        nuevoBotonEliminar.addEventListener('click', function() {
            document.getElementById('reseniaIdEliminar').value = this.getAttribute('data-id');
        });
    }

    // Función para resetear el formulario
    function resetForm() {
        comentario.value = '';
        valoracionInput.value = '0';
        document.getElementById('gustoSi').checked = true;
        updateStars(0);
    }

    // Modal para eliminar reseña
    const eliminarBotones = document.querySelectorAll('.eliminar-resenia');
    const reseniaIdEliminar = document.getElementById('reseniaIdEliminar');

    eliminarBotones.forEach(boton => {
        boton.addEventListener('click', function () {
            const id = this.getAttribute('data-id');
            reseniaIdEliminar.value = id;
        });
    });

    // Formulario de eliminación
    const eliminarReseniaForm = document.getElementById('eliminarReseniaForm');
    if (eliminarReseniaForm) {
        eliminarReseniaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(eliminarReseniaForm);
            const reseniaId = document.getElementById('reseniaIdEliminar').value;
            
            fetch('/Servicios/EliminarResenia', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Eliminar la reseña del DOM
                    const reseniaElement = document.getElementById(`resenia-${reseniaId}`);
                    if (reseniaElement) {
                        reseniaElement.remove();
                        
                        // Verificar si no hay más reseñas y mostrar mensaje de "No hay comentarios"
                        const reseniasItems = document.querySelectorAll('.resenia-item');
                        if (reseniasItems.length === 0) {
                            // Crear el mensaje de "No hay comentarios"
                            const noCommentsElement = document.createElement('div');
                            noCommentsElement.id = 'noComments';
                            noCommentsElement.className = 'text-center py-5';
                            noCommentsElement.innerHTML = `
                                <p class="mb-0">No hay comentarios para este servicio.</p>
                                <p class="text-muted">¡Sé el primero en comentar!</p>
                            `;
                            reseniasList.appendChild(noCommentsElement);
                        }
                    }
                    
                    // Cerrar el modal de confirmación
                    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal'));
                    modal.hide();
                    
                    // Mostrar el modal de éxito
                    const reseniaEliminadaModal = new bootstrap.Modal(document.getElementById('reseniaEliminadaModal'));
                    reseniaEliminadaModal.show();
                } else {
                    console.error('Error al eliminar la reseña:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }

    // Mostrar modal de éxito si es necesario
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('reseniaRegistrada') === 'true') {
        const reseniaExitoModal = new bootstrap.Modal(document.getElementById('reseniaExitoModal'));
        reseniaExitoModal.show();
        // Eliminar parámetro de la URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    if (urlParams.get('reseniaEliminada') === 'true') {
        const reseniaEliminadaModal = new bootstrap.Modal(document.getElementById('reseniaEliminadaModal'));
        reseniaEliminadaModal.show();
        // Eliminar parámetro de la URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});
</script>

<script>
    AOS.init({ once: true });
    function mostrarModalLogin() {
        var modal = new bootstrap.Modal(document.getElementById('loginRequeridoModal'));
        modal.show();
    }
    document.addEventListener("DOMContentLoaded", function () {
        var usuarioAutenticado = @(usuarioAutenticado.ToString().ToLower());
        if (!usuarioAutenticado) {
            var bloqueo = document.getElementById('formularioBloqueo');
            bloqueo.style.display = 'block';
        }
    });
    document.getElementById('formulario').addEventListener('submit', function (e) {
        var iti = window.intlTelInputGlobals.getInstance(document.getElementById('telefono'));

        // Validar que el número sea válido
        if (!iti.isValidNumber()) {
            e.preventDefault();
            var errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
            document.getElementById('errorReservaMensaje').innerHTML = "El teléfono debe tener el formato internacional correcto.";
            errorModal.show();
            return false;
        }

        var numeroIntl = iti.getNumber();

        var countryCode = iti.getSelectedCountryData().dialCode;

        var numeroFormateado = numeroIntl.replace('+' + countryCode, '+' + countryCode + ' ');

        document.getElementById('telefono_internacional').value = numeroFormateado;
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Inicializa intl-tel-input
        var input = document.querySelector("#telefono");
        window.intlTelInput(input, {
            initialCountry: "pe",
            preferredCountries: ["pe", "ar", "es", "us", "br"],
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js"
        });
        // Referencias a elementos del formulario
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        const formulario = document.getElementById('formulario');
        
        // Guardar fecha y hora al seleccionarlas
        if (fechaInput) {
            fechaInput.addEventListener('change', function() {
                localStorage.setItem('reserva_fecha', this.value);
            });
        }

        if (horaInput) {
            horaInput.addEventListener('change', function() {
                localStorage.setItem('reserva_hora', this.value);
            });
        }

        // Guardar al enviar formulario
        if (formulario) {
            formulario.addEventListener('submit', function(e) {
                // Validación del teléfono
                const iti = window.intlTelInputGlobals.getInstance(document.getElementById('telefono'));
                if (!iti.isValidNumber()) {
                    e.preventDefault();
                    const errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
                    document.getElementById('errorReservaMensaje').innerHTML = "El teléfono debe tener el formato internacional correcto.";
                    errorModal.show();
                    return false;
                }

                // Formatear teléfono internacional
                const numeroIntl = iti.getNumber();
                const countryCode = iti.getSelectedCountryData().dialCode;
                const numeroFormateado = numeroIntl.replace('+' + countryCode, '+' + countryCode + ' ');
                document.getElementById('telefono_internacional').value = numeroFormateado;
                
                // Guardar fecha y hora en localStorage
                const fechaValue = document.getElementById('fecha').value;
                const horaValue = document.getElementById('hora').value;
                if (fechaValue && horaValue) {
                    localStorage.setItem('reserva_fecha', fechaValue);
                    localStorage.setItem('reserva_hora', horaValue);
                }
            });
        }
        // Inicializa mensaje de éxito
        const successMessage = document.querySelector(".success-message");
        if (successMessage) {
            setTimeout(() => {
                successMessage.classList.add("hide");
                setTimeout(() => successMessage.remove(), 500);
            }, 10000);
        }
        // Mostrar modal de error si existe
        var errorMsg = '@Html.Raw(TempData["ErrorReserva"])';
        if (errorMsg && errorMsg !== '') {
            var errorModal = new bootstrap.Modal(document.getElementById('errorReservaModal'));
            document.getElementById('errorReservaMensaje').innerHTML = errorMsg;
            errorModal.show();
            return;
        }
        // Inicializar Cruces
        const crucesBtn = document.getElementById('dropdownReservas');
        const listGroup = document.querySelector('.list-group');
        const allItems = Array.from(document.querySelectorAll('.list-group-item[data-fecha]'));

        function actualizarCruces() {
            if (!fechaInput || !crucesBtn) return;
            const selectedDate = fechaInput.value;
            let count = 0;
            allItems.forEach(item => {
                if (item.getAttribute('data-fecha') === selectedDate) {
                    item.style.display = '';
                    count++;
                } else {
                    item.style.display = 'none';
                }
            });
            // Actualiza el contador y el estado del botón
            const countSpan = crucesBtn.querySelector('span');
            if (count > 0) {
                crucesBtn.disabled = false;
                if (countSpan) {
                    countSpan.innerHTML = `<i class="far fa-calendar-alt me-2"></i>Ver Posibles Cruces (${count})`;
                }
            } else {
                crucesBtn.disabled = true;
                if (countSpan) {
                    countSpan.innerHTML = `<i class="far fa-calendar-alt me-2"></i>No hay cruces`;
                }
            }
        }
        if (fechaInput && crucesBtn) {
            fechaInput.addEventListener('input', actualizarCruces);
            actualizarCruces();
        }

        // Mostrar modal de calendario si la reserva fue exitosa
        const reservaExitosa = '@TempData["ReservaExitosa"]';
        if (reservaExitosa && reservaExitosa !== '') {
            const calendarioModal = new bootstrap.Modal(document.getElementById('calendarioModal'));
            calendarioModal.show();

            // Obtener datos guardados en localStorage
            const fechaGuardada = localStorage.getItem('reserva_fecha');
            const horaGuardada = localStorage.getItem('reserva_hora');

            // Datos para el evento
            const nombreServicio = '@Html.Raw(Json.Serialize(Model.ser_nombre))'.replace(/"/g, '');
            const titulo = `Reserva Marimon - ${nombreServicio}`;
            const descripcion = `Servicio: ${nombreServicio}`;
            const location = 'Jr. Gral. Felipe Santiago Salaverry 44, Lima 15022, Perú';

            // Crear fecha con los valores guardados
            const fechaHora = new Date();
            
            if (fechaGuardada) {
                const [year, month, day] = fechaGuardada.split('-');
                fechaHora.setFullYear(parseInt(year), parseInt(month) - 1, parseInt(day));
            }

            if (horaGuardada) {
                const [hours, minutes] = horaGuardada.split(':');
                fechaHora.setHours(parseInt(hours), parseInt(minutes), 0);
            }

            // Formato para Google Calendar
            const fechaInicio = fechaHora.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const fechaFin = new Date(fechaHora.getTime() + 60 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const googleUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titulo)}&dates=${fechaInicio}/${fechaFin}&details=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(location)}`;
            document.getElementById('googleCalendarLink').href = googleUrl;

            // Formato para Outlook Calendar 
            const fechaInicioOutlook = fechaHora.toISOString().replace('.000', '');
            const fechaFinOutlook = new Date(fechaHora.getTime() + 60 * 60 * 1000).toISOString().replace('.000', '');
            const outlookUrl = `https://outlook.office.com/calendar/action/compose?subject=${encodeURIComponent(titulo)}&startdt=${fechaInicioOutlook}&enddt=${fechaFinOutlook}&body=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(location)}`;
            document.getElementById('outlookCalendarLink').href = outlookUrl;
        }
    });
</script>